<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://jackmleitch.github.io/PersonalWebsite/blog</id>
    <title>Jack Leitch Blog</title>
    <updated>2022-06-10T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://jackmleitch.github.io/PersonalWebsite/blog"/>
    <subtitle>Jack Leitch Blog</subtitle>
    <icon>https://jackmleitch.github.io/PersonalWebsite/img/favicon.png</icon>
    <entry>
        <title type="html"><![CDATA[Building NLP Powered Applications with Hugging Face Transformers]]></title>
        <id>Essay-Companion</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Essay-Companion"/>
        <updated>2022-06-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[... and deploying on Google Chrome with FastAPI and Docker]]></summary>
        <content type="html"><![CDATA[<p><strong>... and deploying on Google Chrome with FastAPI and&nbsp;Docker</strong></p><p>I recently finished the fantastic new Natural Language Processing with Transformers book written by a few guys on the Hugging Face team and was inspired to put some of my newfound knowledge to use with a little NLP-based project. While searching for some ideas I came across an <a href="https://medium.com/data-science-at-microsoft/developing-microsoft-edge-extensions-powered-by-sota-nlp-models-f3991f18daa4" target="_blank" rel="noopener noreferrer">excellent blog post</a> by Tezan Sahu in which he built a Microsoft Edge extension to paraphrase text highlighted on your screen. I wanted to take this a step further by:</p><ol><li><p>optimizing model inference with <strong>ONNX runtime</strong> and <strong>quantization</strong>,</p></li><li><p>include features such as summarization, name entity recognition (NER), and keyword extraction.</p></li></ol><p><img loading="lazy" alt="gif" src="/PersonalWebsite/assets/images/EssayCompanionDemoShort-e8fd8dfd09b627f4d403a538a4a12360.gif" width="2560" height="1546" class="img_ev3q"></p><p>The idea is that this creates the ultimate essay companion as it can help quickly understand text with the summaries and NER, and it can get those creative juices flowing with the paraphrased text and keyword synonyms. Obviously, I would hope people use it to rewrite their own work and not other peoples…</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p><strong>TL;DR:</strong> <a href="https://github.com/jackmleitch/EssayCompanion" target="_blank" rel="noopener noreferrer">This repository</a> contains all the code mentioned in this article. ML stuff can be found in the <a href="https://github.com/jackmleitch/EssayCompanion/tree/main/src" target="_blank" rel="noopener noreferrer">src</a> folder and Chrome extension stuff is in the <a href="https://github.com/jackmleitch/EssayCompanion/tree/main/extension" target="_blank" rel="noopener noreferrer">extension</a> folder.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="models">Models<a class="hash-link" href="#models" title="Direct link to heading">​</a></h2><p>There are four different models (and tokenizers) in action in this extension, three of which were found on Hugging Face!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="t5-paraphrasing-model"><a href="https://huggingface.co/ramsrigouthamg/t5-large-paraphraser-diverse-high-quality" target="_blank" rel="noopener noreferrer">T5 Paraphrasing Model</a><a class="hash-link" href="#t5-paraphrasing-model" title="Direct link to heading">​</a></h3><p>This was the largest model used, coming in at 2.75Gb (!), and was fine-tuned for paraphrasing by Ramsri Goutham. <strong>T5</strong> is an encoder-decoder model pre-trained on a multi-task mixture of unsupervised and supervised tasks and for which each task is converted into a text-to-text format.</p><p>The text is first split into sentences using <strong>NLTK</strong>'s sentence tokenizer sent_tokenize. Each sentence was then passed through the T5 model and the paraphrased output for each sentence was joined to get a new paraphrased paragraph.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/paraphrase/paraphrasing_model.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ParaphraseModel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Provides utility to load HuggingFace paraphrasing model and generate paraphrased text."""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_ckpt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ramsrigouthamg/t5-large-paraphraser-diverse-high-quality"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_beams</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        :param model_ckpt: path to HuggingFace model checkpoint, default is the T5 paraphraser</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        :param num_beams: number of beams to perform beam search when generating new text</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_beams </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_beams</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_ckpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_ckpt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">torch_device </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cuda"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_available</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cpu"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_ckpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoModelForSeq2SeqLM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_ckpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">paraphrase_text_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        Tokenize sentences and then pass to model to paraphrase text.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        :param input_text: input text to feed to model</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        :return: paraphrased text</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sentences </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sent_tokenize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentences</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> truncation</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> padding</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"longest"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            max_length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"pt"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">torch_device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        translated </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">batch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_beams</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_beams</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            num_return_sequences</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> temperature</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paraphrased_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">translated</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> skip_special_tokens</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_ckpt </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ramsrigouthamg/t5-large-paraphraser-diverse-high-quality"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># remove 'paraphrasedoutput: ' from result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            paraphrased_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sentence</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> sentence </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> paraphrased_text</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        paraphrased_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paraphrased_text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> paraphrased_text</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Some example output:</p><p><em>The ultimate test of your knowledge is your capacity to convey it to another <strong>=&gt;</strong> Your ability to pass it from one to another is the ultimate measure of your intelligence.</em></p><p>That's pretty good, we can see our paraphrased text is coherent and has a different structure from the original text!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bart-summarization-model"><a href="https://huggingface.co/facebook/bart-large-cnn" target="_blank" rel="noopener noreferrer">BART Summarization Model</a><a class="hash-link" href="#bart-summarization-model" title="Direct link to heading">​</a></h3><p><strong>BART</strong> is also an encoder-decoder (seq2seq) model with a bidirectional (like BERT) encoder and an autoregressive (like GPT) decoder. BART is pre-trained by (1) corrupting text with an arbitrary noising function, and (2) learning a model to reconstruct the original text.</p><p>As an example, a recent 250-word long <a href="https://www.eurogamer.net/portable-electronic-devices-sold-in-the-eu-will-require-usb-c-charging-by-autumn-2024" target="_blank" rel="noopener noreferrer">news article</a> regarding USB-C rule enforcements in the EU is summarized in 55 words:</p><p><em>By autumn 2024, all portable electronic devices sold in the EU will need to use USB Type-C for charging. The aim is to reduce electronic waste and be more consumer-friendly by having just one "common charger". The biggest impact will be Apple's iPhones and iPads, which will no longer be able to use lightning cables.</em></p><p>Wow! It's worked superbly and picks out all the key points made in the article concisely.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="distilbert-nermodel"><a href="https://huggingface.co/elastic/distilbert-base-uncased-finetuned-conll03-english" target="_blank" rel="noopener noreferrer">DistilBERT NER&nbsp;Model</a><a class="hash-link" href="#distilbert-nermodel" title="Direct link to heading">​</a></h3><p>A <strong>DistilBERT</strong> base uncased model fine-tuned for <strong>NER</strong> using the conll03 English dataset was used. DistilBERT is a smaller and faster model than <strong>BERT</strong>, which was pre-trained on the same corpus in a self-supervised fashion, using the BERT base model as a teacher. The NER model is simply a DistilBERT encoder with a token classification head added to the end to predict each entity: person, location, organization, and misc.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/ner/ner_model.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">NERModel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Load name entity recognition model and build prediction pipeline"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_ckpt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"elastic/distilbert-base-uncased-finetuned-conll03-english"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_ckpt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_ckpt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_ckpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoModelForTokenClassification</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_ckpt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># id to label mapping to convert predictions back to entities</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id2label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id2label</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ner_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        Build ner pipeline and return parsed model output</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        :param query: query to pass to the model</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pipe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_ckpt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tokenizer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'ner'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            aggregation_strategy</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"simple"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the chrome extension, the NER results were rendered in HTML using <strong>SpaCy</strong>. Some example output is below.</p><p><img loading="lazy" alt="image" src="/PersonalWebsite/assets/images/ner_results-13224909cb7c46d095caab961e1098d7.png" width="1600" height="250" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="keybert-keyword-extraction-model"><a href="https://maartengr.github.io/KeyBERT/" target="_blank" rel="noopener noreferrer">KeyBERT Keyword Extraction Model</a><a class="hash-link" href="#keybert-keyword-extraction-model" title="Direct link to heading">​</a></h3><p>This model leverages BERT text embeddings and cosine similarity to find the sub-phrases in a document that are the most similar to the document itself. The idea is that these sub-phrases are the most important phrases in the text.</p><p>Keywords are first extracted from the text using the <strong>KeyBERT</strong> model. Once the keywords are found, <strong>WordNet</strong> is used to find synonyms for each keyword. It's worth noting that in WordNet, similar words are grouped into a set known as a Synset and the words in a Synset are lemmatized.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/keyword/keybert_model.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">GetKeywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Extract keywords and find synonyms for them"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> KeyBERT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_keywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Get keywords from query text using KeyBERT"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keywords </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">extract_keywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> keywords</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_synonyms_for_keyword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyword</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_synonyms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Find synonyms for a given word"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synonyms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> synonym </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> wordnet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">synsets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">keyword</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> lemma </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> synonym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lemmas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                synonyms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lemma</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"_"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">synonym </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> synonym </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">synonyms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> synonym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> keyword</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">max_synonyms</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_synonyms_for_keywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_synonyms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Find synonyms for all keywords and return them"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keywords </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_keywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keyword_synonyms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> keyword </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> keywords</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synonyms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_synonyms_for_keyword</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">keyword</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_synonyms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">synonyms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                keyword_synonyms</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">keyword</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> synonyms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> keyword_synonyms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The keywords and associated synonyms found in the sentence 'The ultimate test of your <strong>knowledge</strong> is your capacity to <strong>convey</strong> it to another' are:</p><ul><li>Knowledge: comprehension, cognition, grasp</li><li>Convey: transport, carry, deliver</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="model-optimization">Model Optimization<a class="hash-link" href="#model-optimization" title="Direct link to heading">​</a></h2><p>The initial performance of the models was <em>OK</em> when running inference on GPU but very poor when running on CPU. Even GPU inference wasn't as fast as I'd like since the decoder models have to sequentially decode the model output which cannot be parallelized. Memory was also an issue as I wanted to be able to use this extension on devices with limited memory and compute resources (I have my <em>ancient</em> 2015 MacBook pro in mind…) and two of the models were over 1.5Gb in size! My goal was to reduce the memory footprint of these models as much as possible and optimize performance on CPU inference while maintaining model performance.</p><p><strong>Quantization</strong> and <strong>distillation</strong> are two techniques commonly used to deal with size and performance challenges. Distillation was already used with the NER model as DistilBERT is a distilled version of the O.G. BERT model. In my case, distillation of T5/BART was out of the question due to my limited compute resources.</p><p>The first step I took was to convert the PyTorch models to ONNX, an open representation format for machine learning algorithms, this allows us to optimize inference for a targeted device (CPU in this case). The Hugging Face Transformer library includes a <a href="https://github.com/huggingface/transformers/blob/main/src/transformers/convert_graph_to_onnx.py" target="_blank" rel="noopener noreferrer">tool</a> to easily convert models to ONNX and this was used to convert the DistilBERT model. Converting the encoder-decoder models was a little trickier as seq2seq conversions currently aren't supported by Hugging Face's ONNX converter. I was able to make use of <a href="https://github.com/Ki6an/fastT5" target="_blank" rel="noopener noreferrer">this</a> fantastic GitHub repository, however, which converts the encoder and decoder separately and wraps the two converted models in the Hugging Face Seq2SeqLMOutput class.</p><p>After the models were converted to ONNX, QInt8 quantization was used to approximate floating-point numbers with lower bit width numbers, dramatically reducing the memory footprint of the model and accelerating performance as computations can be further optimized. Quantization can however introduce a loss in performance as we lose information in the transformation, but it has been extensively demonstrated (e.g. see <a href="https://arxiv.org/pdf/2103.13630.pdf" target="_blank" rel="noopener noreferrer">here</a>) that weights can be represented in 8-bit integers without a significant drop in performance. It comes as no surprise that the quantization of ONNX models is super easy!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/ner/quantize_ner_model.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> onnxruntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quantization </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> quantize_dynamic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> QuantType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"models/ner/model/model.onnx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"models/ner/model/model_quant.onnx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quantize_dynamic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_input</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> weight_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuantType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">QInt8</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then optimize model inference for CPU usage!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/ner/onnx_ner_model.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> onnxruntime </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InferenceSession</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SessionOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GraphOptimizationLevel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> AutoTokenizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_model_for_provider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> provider</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'CPUExecutionProvider'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Create CPU inference session for ONNX runtime to boost performance</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param model_path: path to *.onnx model</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param provider: CPU/CUDA</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: onnx runtime session</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SessionOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intra_op_num_threads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">graph_optimization_level </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GraphOptimizationLevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ORT_ENABLE_ALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InferenceSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> providers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">disable_fallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">NEROnnxModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""Build NER onnx model and aggregate results into data to be rendered"""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"models/ner/model/model_quant.onnx"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_model_for_provider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"models/ner/tokenizer/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id2label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"O"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"B-PER"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"I-PER"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"B-ORG"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"I-ORG"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"B-LOC"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"I-LOC"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"B-MISC"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"I-MISC"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__call__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get model inputs and other required arrays</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_inputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"np"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return_special_tokens_mask</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> return_offsets_mapping</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        special_tokens_mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"special_tokens_mask"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        offset_mapping </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_inputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"offset_mapping"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># pass to model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logits </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_inputs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        predictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argmax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logits</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_inputs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"input_ids"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_outputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"sentence"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sentence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"input_ids"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> input_ids</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"predictions"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"offset_mapping"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> offset_mapping</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"special_tokens_mask"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> special_tokens_mask</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># aggregate entitity information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pre_entities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gather_pre_entities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">model_outputs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        entities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aggregate_words</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pre_entities</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        entities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group_entities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entities</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">build_final_output</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sentence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> entities</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> results</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The results from the model optimizations are shown below. We can see that our efforts resulted in a <strong>~2x reduction in size</strong> and a <strong>~3x latency boost</strong>!</p><p><img loading="lazy" alt="alt-text-1" src="/PersonalWebsite/assets/images/model_size-169b5f2129c8e70b59e0b26ac6f45436.png" title="title-1" width="1258" height="752" class="img_ev3q"> <img loading="lazy" alt="alt-text-2" src="/PersonalWebsite/assets/images/model_latency-61c029585368a429fedf49977aebad65.png" title="title-2" width="1748" height="1064" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-a-model-endpoint-with-fastapi-docker">Deploying a Model Endpoint with FastAPI +&nbsp;Docker<a class="hash-link" href="#deploying-a-model-endpoint-with-fastapi-docker" title="Direct link to heading">​</a></h2><p>To deploy our application, I used two tools as the main building blocks: <a href="https://fastapi.tiangolo.com" target="_blank" rel="noopener noreferrer">FastAPI</a> and <a href="https://www.docker.com" target="_blank" rel="noopener noreferrer">Docker</a>. FastAPI makes building a web framework around the models super easy and Docker is a containerization tool allowing us to easily package and run the application in any environment.</p><p>Using FastAPI we package the model and build an API to communicate with it. We also use Pydantic to validate user input and model output, we can never be too careful! For example, we ensure the input text is a string, the response from the summarization model is a string, and the keyword extraction model returns a dictionary containing a list of strings.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/main.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> fastapi </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FastAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pydantic </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BaseModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> starlette</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">middleware</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cors </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> CORSMiddleware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">paraphrasing_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParaphraseOnnxPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_beams</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ner_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NEROnnxModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">summarization_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SummarizeOnnxPipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_beams</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyword_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GetKeywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FastAPI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># allow CORS requests from any host so that the JavaScript can communicate with the server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_middleware</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CORSMiddleware</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> allow_origins</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"*"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> allow_methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"*"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> allow_headers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"*"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">KeywordResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">AllModelsResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    original</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paraphrased</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ParagraphResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name_entities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> NERResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    summarized</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ParagraphResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyword_synonyms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KeywordResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/predict"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AllModelsResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    paraphrased_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParagraphResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">paraphrasing_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ner_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> NERResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">render_data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ner_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    summarized_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParagraphResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">summarization_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    keyword_synonyms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> KeywordResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">keyword_pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_synonyms_for_keywords</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> AllModelsResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        original</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> paraphrased</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">paraphrased_text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name_entities</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ner_text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> summarized</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">summarized_text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keyword_synonyms</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">keyword_synonyms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Docker is then used to containerize the API server, this allows us to run the application on any machine without worrying about the faff of reproducing my exact environment. To build a Docker image of the server, I created a Dockerfile in the root folder of the project.</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Dockerfile</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">FROM</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">ubuntu</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">20.04</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">COPY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">src </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">api</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">COPY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">models </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">api</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">models</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">COPY</span><span class="token plain"> requirements</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">txt</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">requirements</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">RUN</span><span class="token plain"> apt</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> update \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> apt</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">get</span><span class="token plain"> install python3</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dev python3</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pip </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> pip3 install </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">r requirements</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">RUN</span><span class="token plain"> python3 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">m nltk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">downloader</span><span class="token plain"> punkt wordnet omw</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">ENV</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PYTHONPATH</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">WORKDIR</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">EXPOSE</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">ENTRYPOINT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"uvicorn"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">CMD</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"api.main:app"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"--host"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0.0.0.0"</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To host the extension online we could use either <strong>Azure's Container Service</strong> or <strong>AWS' Elastic Container Service</strong>. I haven't gotten around to this yet but plan on doing it at some point soon!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-the-google-chrome-extension">Building The Google Chrome Extension&nbsp;<a class="hash-link" href="#building-the-google-chrome-extension" title="Direct link to heading">​</a></h2><p>The last piece of the puzzle was to build the chrome extension which consisted of 3 parts:</p><ul><li><code>manifest.json</code> containing the configuration of the extension</li><li><code>popup.html</code> &amp; style.css defining the user interface</li><li><code>popup.js</code> to communicate with the API and implement the actual functionality of the extension.</li></ul><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/extension/popup/popup.js</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Issue a POST request with a request body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doPost</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">url</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> body</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> xmlHttp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">XMLHttpRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onreadystatechange</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">readyState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">responseText</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"POST"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setRequestHeader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Content-type"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"application/json; charset=utf-8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xmlHttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I followed <a href="https://medium.com/data-science-at-microsoft/developing-microsoft-edge-extensions-powered-by-sota-nlp-models-f3991f18daa4" target="_blank" rel="noopener noreferrer">this</a> fantastic tutorial to build the web extension so please check it out if you're looking to do something similar. The only thing I changed myself was changing the output to include more models and rendering the NER results in HTML. This is what the final product looks like for some example text found online!</p><table><thead><tr><th><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/demo_pt1-33d4d4f0ae1c293efb1a6387f49e8fcb.png" width="788" height="660" class="img_ev3q"></th><th><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/demo_pt2-cfe360205ed78dbc0d8d4cd39e4c0431.png" width="752" height="592" class="img_ev3q"></th></tr></thead><tbody><tr><td><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/demo_pt3-8fd7c821cf79fcf930e7e7a387ea8f9f.png" width="758" height="644" class="img_ev3q"></td><td><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/demo_pt4-0cc9c43178fc9d5725d04b9f4a4309d3.png" width="736" height="654" class="img_ev3q"></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="concluding-remarks">Concluding Remarks&nbsp;<a class="hash-link" href="#concluding-remarks" title="Direct link to heading">​</a></h2><p>In this blog post, I've shown how you can leverage state-of-the-art transformer models to build 'smart' text-based applications. I started by finding suitable models for paraphrasing, summarization, name entity recognition, and keyword extraction before optimizing them for model inference on CPU. I then deployed the models at an API endpoint using FastAPI and containerized the application for reproducibility.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>All the code for this project can be found in <a href="https://github.com/jackmleitch/EssayCompanion" target="_blank" rel="noopener noreferrer">this GitHub repository</a>.</p></div></div><p>Feel free to reach out to me on <a href="https://www.linkedin.com/in/jackmleitch/" target="_blank" rel="noopener noreferrer">LinkedIn</a>!</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="NLP" term="NLP"/>
        <category label="Hugging Face" term="Hugging Face"/>
        <category label="Chrome Extension" term="Chrome Extension"/>
        <category label="Docker" term="Docker"/>
        <category label="Python" term="Python"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Building Interpretable Models on Imbalanced Data]]></title>
        <id>Churn-Prediction</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Churn-Prediction"/>
        <updated>2022-01-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Predicting customer churn from a telecom provider]]></summary>
        <content type="html"><![CDATA[<p><strong>Predicting customer churn from a telecom provider</strong></p><p>I’ve always believed that to truly learn data science you need to practice data science and I wanted to do this project to practice working with imbalanced classes in classification problems. This was also a perfect opportunity to start working with <a href="https://mlflow.org/" target="_blank" rel="noopener noreferrer">mlflow</a> to help track my machine learning experiments: it allows me to track the different models I have used, the parameters I’ve trained with, and the metrics I’ve recorded.</p><p>This project was aimed at predicting customer churn using the telecommunications data found on <a href="https://www.kaggle.com/c/customer-churn-prediction-2020/overview" target="_blank" rel="noopener noreferrer">Kaggle</a> (which is a publicly available synthetic dataset). That is, we want to be able to predict if a given customer is going the leave the telecom provider based on the information we have on that customer. Now, why is this useful? Well, if we can predict which customers we think are going to leave <strong>before</strong> they leave then we can try to do something about it! For example, we could target them with specific offers, and maybe we could even use the model to provide us insight into what to offer them because we will know, or at least have an idea, as to why they are leaving.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance-vs-interpretability">Performance vs Interpretability<a class="hash-link" href="#performance-vs-interpretability" title="Direct link to heading">​</a></h2><p>It’s very important to know and understand the problem/task at hand before we start to even think about writing any code. Would it be useful in this case to build a really powerful model like XGBOOST? No, of course not. Our goal isn’t to squeeze every drop of performance out of our model. Our goal is to <strong>understand</strong> why people are leaving so we can do something about it and try to get them to stay. In an ideal world, we would build a very interpretable model, but in reality, we may have to find a happy medium between performance and interpretability. As always, logistic regression would be a good start.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="model-evaluation">Model Evaluation<a class="hash-link" href="#model-evaluation" title="Direct link to heading">​</a></h2><p>We now need to decide how we are going to evaluate our models and what we are going to be happy with. I think it’s important to decide an end goal beforehand as otherwise, it’s going to be hard to decide when to stop, squeezing out those extra 1%s is not worth it a lot of the time.</p><p>Due to the nature of our data, our classes are likely going to be highly imbalanced, with the case we are interested in (customers leaving) being the minority class. This makes selecting the right metric super important.</p><p><img loading="lazy" alt="alt text" src="/PersonalWebsite/assets/images/imbalanced_meme-bab6c51c1b7314b45a9e489782d448fa.jpeg" width="1070" height="1380" class="img_ev3q"></p><p>The metrics we are going to be interested in are <strong>precision</strong>, <strong>recall</strong>, and other metrics associated with these. Precision is the ratio of correct positive predictions to the overall number of positive predictions. Recall is the ratio of correct positive predictions to the overall number of positive predictions in the dataset. In our case we are looking at trying to retain customers by predicting which customers are going to leave: so we aren’t too fussed if we miss-classify some customers as ‘churn’ when they are not (false positives). If anything, these miss-classifications might be customers that would soon become ‘churn’ if nothing changes as they may lie on the edge of the decision boundary. So, we are looking to <strong>maximize recall</strong> as it will minimize the number of false negatives.</p><p>We are also going to look at the <strong>F-measure</strong> as it provides a way to express both concerns of precision and recall with a single score — we don’t just want to forfeit precision to get 100% recall!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="model-specifications">Model Specifications<a class="hash-link" href="#model-specifications" title="Direct link to heading">​</a></h2><p>Once we have built our final model, we can then use a precision-recall curve to optimize our performance on the positive (minority class). In this case, we are going to assume that stakeholders in our imaginary telecoms business want to <strong>achieve a recall of 0.80</strong> (i.e. we identify 80% of the positive samples correctly) while maximizing precision.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data">Data<a class="hash-link" href="#data" title="Direct link to heading">​</a></h2><ul><li><p><code>train.csv</code> — the training set. Contains 4250 rows with 20 columns. 3652 samples (85.93%) belong to class churn=no and 598 samples (14.07%) belong to class churn=yes.</p></li><li><p><code>test.csv</code> — the test set. Contains 850 rows with 18 columns.</p></li></ul><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/read_data.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> src</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_data </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> read_params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># load in training data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"params.yaml"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">external_data_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"external_data_config"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"external_data_csv"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">external_data_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sep</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">","</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"utf-8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># check we have our 20 cols</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>EDA (along with all the modeling etc.) was done in different python scripts and I have chosen to not include it here as it is irrelevant to the topic I am writing about. It is nonetheless very important and you can find this whole project on my <a href="https://github.com/jackmleitch" target="_blank" rel="noopener noreferrer">Github page</a>.</p><p>Due to the high cardinality of the state columns, we need to be careful when encoding them otherwise we will end up with 50 different features!</p><p><code>df.head()</code>
<img loading="lazy" alt="alt text" src="/PersonalWebsite/assets/images/data_head-cc6017c6d4e6eea7eab7fbcf9f0451f0.png" width="5070" height="355" class="img_ev3q"></p><p>We can look at a correlation matrix to see any initial promising features.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/plot_correlation_matrix.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> seaborn </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> sns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> matplotlib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pyplot </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> plt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_theme</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">style</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"white"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Compute the correlation matrix</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">corr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">corr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Generate a mask for the upper triangle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">triu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ones_like</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dtype</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set up the matplotlib figure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ax </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subplots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">figsize</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Generate a custom diverging colormap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diverging_palette</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">230</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> as_cmap</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Draw the heatmap with the mask and correct aspect ratio</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sns</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">heatmap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cmap</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cmap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vmax</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">.3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> center</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            square</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> linewidths</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cbar_kws</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"shrink"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">.5</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="alt text" src="/PersonalWebsite/assets/images/corr_matrix-5cf7d8f20147d8ab23b4a23fc511c2d4.png" width="745" height="671" class="img_ev3q"></p><p>Ok, this doesn’t look great but we can see that churn is somewhat correlated with total_day_minutes, total_day_charge, and number_customer_service_calls. Let’s build a simple <strong>baseline model</strong> with total_day_minutes and number_customer_service_calls (we omit total_day_charge because it’s strongly correlated with total_day_minutes).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="feature-engineering">Feature Engineering<a class="hash-link" href="#feature-engineering" title="Direct link to heading">​</a></h2><p>We can generate a few features to encapsulate daily totals. We also map the state feature to the regions the state belongs to as it massively reduces the feature dimensionality. Finally, we can map churn target value to binary as this is required for a lot of models.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/preprocess_data.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">preprocess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># add new features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_minutes'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_day_minutes'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_eve_minutes'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_night_minutes'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_calls'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_day_calls'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_eve_calls'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_night_calls'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_charge'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_day_charge'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_eve_charge'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'total_night_charge'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># target mapping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    target_mapping </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"no"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"yes"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target_mapping</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># map state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    state_mapping </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'AK'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'AL'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'AR'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'AS'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'AZ'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CO'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'CT'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'DC'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'DE'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'FL'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'GA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'GU'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'HI'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'IA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ID'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'IL'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'IN'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'KS'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'KY'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'LA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MD'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ME'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'MI'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MN'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MO'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MP'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MS'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'MT'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">'NC'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ND'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NE'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NH'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NJ'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'NM'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NV'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'NY'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'OH'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'OK'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'OR'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'PA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'PR'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'RI'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'SC'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'SD'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'TN'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">'TX'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'UT'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'VA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'VI'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'O'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'VT'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'N'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'WA'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'WI'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'M'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'WV'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'S'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'WY'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'W'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'state'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'state'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_mapping</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> df</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># preprocess dataframe and add features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> preprocess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="modeling">Modeling<a class="hash-link" href="#modeling" title="Direct link to heading">​</a></h2><p>The first thing that always needs to be done is to split the data into train and validation sets as it is a vital step to avoid overfitting, improve generalizability, and help us compare potential models. In this case, we use stratified K-fold cross-validation as our dataset is highly imbalanced and we want to ensure the class distribution is consistent across folds.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/kfold.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_selection </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StratifiedKFold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">stratKFold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_splits</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Perform stratified K fold cross validation on training set</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param df: pd dataframe to split</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param n_splits: number of folds</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: df with kfold column</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create new column 'kfold' with val -1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"kfold"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frac</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> random_state</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># target values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialise kfold class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StratifiedKFold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_splits</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">n_splits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kfold"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> df</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stratKFold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="baseline-model">Baseline Model<a class="hash-link" href="#baseline-model" title="Direct link to heading">​</a></h3><p>We start by building a simple baseline model so that we have something to compare our later models to. In a regression scenario we could simply use the average of the target variable at every prediction, in our classification case however we are going to use a logistic regression model trained on our two most correlated features.</p><p>Before we start let's initialize Mlflow and write a general scoring function to evaluate our model.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/model_scoring.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> f1_score</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_score</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_score</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># initialize mlflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"mlflow/customer_churn_model"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># scoring function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns corresponding metric scores</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param y: true y values</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param preds: predicted y values</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: f1_score, recall, and precision scores</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f1_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recall </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recall_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    precision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> precision_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">f1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let’s build our baseline model and see how it does on each validation set!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/evaluate_baseline.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">linear_model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LogisticRegression</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">preprocessing </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StandardScaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># baseline model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f1_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> fold </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># define train and validation set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"total_day_minutes"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"number_customer_service_calls"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># target and features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># init and fit scaler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scaler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StandardScaler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scaler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scaler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create and train model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LogisticRegression</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># score model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f1_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recall_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    precision_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># average scores over each fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f1_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recall_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recall_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">precision_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Average F1 = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">f1_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Recall = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">recall_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Precision = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">precision_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># log metrics on mlflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"lr_baseline"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> mlops_run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"F1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f1_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Recall"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Preision"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_avg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.08725, Recall = 0.04847, Precision = 0.44093</p></div></div><p>So yea, the results aren’t great (actually they are terrible) but that only means we are going to get better. This was only a baseline! We can try a few things to improve our model:</p><ul><li><p>We can balance out our classes by over and under-sampling as the imbalance is causing bias towards the majority class in our model.</p></li><li><p>We can train on more features.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="smote-to-over-sample-the-minority-class">SMOTE: To Over-Sample the Minority Class<a class="hash-link" href="#smote-to-over-sample-the-minority-class" title="Direct link to heading">​</a></h3><p>One problem we have with imbalanced classification is that there are too few examples of the minority class for a model to effectively learn the decision boundary. One way to solve this problem would be to over-sample the examples in the minority class. This could be achieved by simply duplicating examples from the minority class in the training dataset, although this does not provide any additional information to the model. An improvement in duplicating examples from the minority class is to synthesize new examples from the minority class. A common technique for this, introduced in <a href="https://arxiv.org/abs/1106.1813" target="_blank" rel="noopener noreferrer">this paper</a>, is SMOTE. It’s worth noting that oversampling isn’t our only option, we could for example under-sample (or combine a mix of the two) by using a technique such as <a href="https://en.wikipedia.org/wiki/Oversampling_and_undersampling_in_data_analysis#Tomek_links" target="_blank" rel="noopener noreferrer">TOMEK-links</a> (SMOTE-TOMEK helps do both under and over-sampling in one go). In our case, however, the best performance boost came from SMOTE alone.</p><p>Before we do this, however, let's write a general feature processing pipeline to get our data ready for modeling. Our function returns a Sklearn pipeline object that we can use to fit and transform our data. It first splits the data into numeric, categorical features, and binary features as we process each of these differently. The categorical features are encoded using one-hot encoding, while the binary features are left alone. Finally, the numeric features have their missing values imputed. Scaling the numeric features was also tried but it didn’t lead to a performance increase. It’s also in our best interest to not scale these as it makes interpreting the results harder.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/feature_pipeline.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">preprocessing </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StandardScaler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MinMaxScaler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OneHotEncoder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OrdinalEncoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impute </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SimpleImputer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pipeline </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Pipeline</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FeatureUnion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> mlxtend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">feature_selection </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ColumnSelector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> category_encoders </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HashingEncoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">feature_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"params.yaml"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param config_path: path to params.yaml file</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: preprocessing feature pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># load in config information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> read_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"raw_data_config"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"model_features"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"numeric"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat_features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"raw_data_config"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"model_features"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"categorical"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    binary_features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"raw_data_config"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"model_features"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"binary"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># transformers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transforms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># categorical pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"categorical"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"select"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ColumnSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">cat_features</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"encode"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OneHotEncoder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"binary"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"select"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ColumnSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">binary_features</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"encode"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OrdinalEncoder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># numeric pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transforms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"numeric"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"select"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ColumnSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cols</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">num_features</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"impute"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SimpleImputer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">missing_values</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strategy</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"median"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># combine features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FeatureUnion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transforms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> features</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A general training function is written below, notice we can choose whether we want to use SMOTE or not. The sampling strategy in SMOTE controls how much we resample the minority class and it’s something we can tune later.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> imblearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">over_sampling </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SMOTE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SMOTENC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LogisticRegression</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solver</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'newton-cg'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smote</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param fold: fold to train model on</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param df: pandas dataframe containing our data</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param model: model to train data on</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param smote: float, if named it is the sampling strategy for SMOTE</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: f1, recall, precision validation score for fold, as well as y_valid and preds</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># feature pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> feature_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># define train and validation set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># target and features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create training and validation features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># smote</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> smote</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        smt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SMOTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">random_state</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sampling_strategy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">smote</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> smt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_resample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create and train model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># score model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Before we use SMOTE, let’s train a logistic regression model on all of the features to try and get a new baseline.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/logistic_regression.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">f1_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> fold </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smote</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scores</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f1_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recall_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recall</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    precision_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># average scores over each fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f1_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recall_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recall_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">precision_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Average F1 = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">f1_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Recall = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">recall_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Precision = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">precision_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># log metrics on mlflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"lr_all_features"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> mlops_run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"F1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f1_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Recall"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Preision"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_avg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.30667, Recall = 0.21075, Precision = 0.57206</p></div></div><p>The results are definitely better than before but still not great. We’ve waited long enough, let’s try using SMOTE! We are going to use SMOTE to over-sample our churn data points so that we end up with equal class distributions.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train_and_eval.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">train_and_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LogisticRegression</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solver</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'newton-cg'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smote</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.75</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log_mlflow</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    train model and evaluate it on each fold</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param df: pandas dataframe containing our data</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param model: model to train data on</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param model_name: string, for tracking on mlflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param params: dict, for tracking on mlflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param log_mlflow: boolean, if true then log results using mlflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: average score for each metric</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    '''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f1_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> fold </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smote</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">smote</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scores</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f1_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recall_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recall</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        precision_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># average scores over each fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f1_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recall_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recall_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    precision_avg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">precision_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Average F1 = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">f1_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Recall = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">recall_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Precision = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">precision_avg</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># log metrics on mlflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log_mlflow</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> mlops_run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"F1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f1_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Recall"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_metric</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Preision"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision_avg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mlflow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> f1_avg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>An important side note: when using SMOTE we need to evaluate performance on a validation set that has <strong>not</strong> been over-sampled. Otherwise, we will not be getting a true performance measure.</p><p><code>train_and_eval(df, model_name="lr_all_features_smote")</code></p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.49789, Recall = 0.69068, Precision = 0.38947</p></div></div><p>Wow! We have boosted the F1 score from 0.31 to 0.50, and the recall has gone from 0.21 to 0.69! An important note is that the precision has practically stayed the same. Why is that? Well, what is precision measuring? Mathematically, precision is the number of true positives divided by the number of true positives plus the number of false positives. It tells us that our model is correct 47% of the time when trying to predict positive samples. So by over-sampling, we have decreased the number of false negatives but we have also increased the number of false positives. This is OK as we decided we will favor false positives over false negatives. An intuitive way to see this change is by looking at a <strong>confusion matrix</strong>.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/confusion_matrix.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> confusion_matrix</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ConfusionMatrixDisplay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># get preds for non-smote and smote models</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> evals </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smote</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> evals_smote </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> train</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smote</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set axis and plot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ax1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ax2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subplots</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nrows</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ncols</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> figsize</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ax1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_title</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Model without SMOTE"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConfusionMatrixDisplay</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_predictions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">evals</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ax</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ax1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ax2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_title</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Model with SMOTE"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConfusionMatrixDisplay</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_predictions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">evals_smote</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ax</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ax2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tight_layout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">show</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="confusion_matrix" src="/PersonalWebsite/assets/images/confusion_matix-e357a717bc8192f47b033a6f877cf244.png" width="1057" height="708" class="img_ev3q"></p><p>We can see that the TP number goes from 33 to 90 and the FN number goes from 86 to 29, great! However, as a consequence of this, we see the FP number goes from 21 to 158. But, as mentioned earlier, we are ok with that as we care more about finding out which customers are going to leave. A little side note: the FP and FN rates can be tuned using the probability threshold and the easiest way to compare the two models is to compare F1 scores.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-selection">Feature Selection<a class="hash-link" href="#feature-selection" title="Direct link to heading">​</a></h3><p>We can train a more complicated model and then use this to select features. Specifically, we train a random forest classifier and then use SHAP values to select the most promising features. Narrowing down the feature space helps reduce dimensionality and generalizability while also making interpreting results easier. It’s a win-win!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/feature_selection.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ensemble </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> RandomForestClassifier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> feature_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">X </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asarray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">todense</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">clf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RandomForestClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> shap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">explainer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TreeExplainer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shap_values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> explainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shap_values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">shap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">summary_plot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shap_values</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> features</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> feature_names</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">feature_names</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> plot_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">'bar</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="imp" src="/PersonalWebsite/assets/images/feature_importance-ed9a5feb9f46dd316e6f387ec1b8265d.png" width="657" height="566" class="img_ev3q"></p><p>We can now define a new pipeline to preprocess and only select our needed features. With this, let’s see how our logistic regression model does with our narrowed-down features!</p><p><code>train_and_eval(df, model_name="lr_selected_features_smote")</code></p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.50255, Recall = 0.69403, Precision = 0.39407</p></div></div><p>Awesome, we’ve removed features and our performance increases slightly. This confirms to us that the other features weren’t important.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="but-can-we-do-better-than-our-logistic-regression">But can we do better than our logistic regression?<a class="hash-link" href="#but-can-we-do-better-than-our-logistic-regression" title="Direct link to heading">​</a></h3><p>It would be easy here to go all guns blazing and train an XGBOOST model, but remember that is <strong>not</strong> our goal. Our goal is to build an interpretable model that we can use to try and keep customers from leaving. As well as logistic regression, decision tree classifiers are very interpretable. Let’s see how it gets on.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/random_forest.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tree </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DecisionTreeClassifier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">train_and_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">DecisionTreeClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"dt_selected_features_smote"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.81529, Recall = 0.84614, Precision = 0.78694</p></div></div><p>It does well! We need to be <strong>very</strong> careful though as decision trees overfit like there is no tomorrow. Let’s go ahead and tune hyperparameters on both models to see if we can optimize things a little more. We will use <a href="https://optuna.org/" target="_blank" rel="noopener noreferrer">Optuna</a> as I just love how easy and fast it is.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hyperparameter-tuning">Hyperparameter Tuning<a class="hash-link" href="#hyperparameter-tuning" title="Direct link to heading">​</a></h3><p>We need a be super careful here, decision trees are very prone to overfitting and this is why random forest models are usually preferred. The random forest can generalize over the data in a better way as the randomized feature selection acts as a form of regularization. As discussed earlier though, in our case we care more about interpretability than performance. Now, although cross-validation is great for seeing how the model is generalizing, it doesn’t necessarily prevent overfitting as we will just end up overfitting the validation sets.</p><p>One measure of overfitting is when the training score is much higher than the testing score. I initially tried setting the objective function in the Optuna trial to the cross-validated validation scores but this still lead to overfitting as DTs don’t have much regularization.</p><p>Another possibility, that is this case worked superbly, is weighting the difference between cross-validated training scores and validation scores vs the validation score itself. For example, for F1 scores, a possible objective function is</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/objective-b0417870e41659c4158dca2307e66701.png" width="1040" height="170" class="img_ev3q"></p><p>In this case, the RMSE of the difference between validation and training is weighted four times less than the validation F1 score. Optimizing this function forces the train and valid score to stay close, while also maximizing the validation score.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/optuna.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> optuna </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Trial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> create_study</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> optuna</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">samplers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TPESampler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> scipy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stats </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> loguniform</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objective</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_jobs</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> random_state</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Objective function to optimize our custom metric using Optuna's TPE sampler</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    '''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># smote param space</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    smote_space </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">'sampling_strategy'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_uniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'sampling_strategy'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># define search spaces</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> model </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> LogisticRegression</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'solver'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_categorical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'solver'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'liblinear'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'saga'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'penalty'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_categorical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'penalty'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'l1'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'l2'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'C'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"C"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'tol'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"tol"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'max_iter'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'max_iter'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'max_depth'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'max_depth'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'min_samples_leaf'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'min_samples_leaf'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'min_samples_split'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'min_samples_split'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">'criterion'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_categorical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'criterion'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"gini"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"entropy"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># feature pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> feature_pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create training and validation features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    X </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_f1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_f1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Create StratifiedKFold object.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StratifiedKFold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_splits</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shuffle</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> random_state</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> train_index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> test_index </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> strat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># split data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">train_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">test_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">train_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">test_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># feature transformations and smote</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        smt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SMOTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">random_state</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">smote_space</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_train_smt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train_smt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> smt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_resample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># train model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train_smt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train_smt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># compute f1 score on valid and training data (without SMOTE!)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preds_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preds_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        train_f1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        valid_f1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f1_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># compute mean of f1 train/valid scores</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    train_f1_mean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_f1_mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">train_f1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">valid_f1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># train/test cross score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> train_valid_f1_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">train_f1_mean</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_f1_mean</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This gives us the following results:</p><ul><li>Logistic Regression Best Hyperparameters: {‘solver’ : ‘liblinear’, ‘penalty’ : ‘l2’, ‘C’ : 1.14, ‘tol’ : 0.0002, max_iter : 150}</li><li>Decision Tree Best Hyperparameters: {‘max_depth’: 7, ‘min_samples_leaf’: 4, ‘min_samples_split’: 10, ‘criterion’: ‘gini’},</li><li>SMOTE Sampling Strategy 0.70 for LR and 0.56 for DT</li></ul><p>Let’s train some models with these parameters and see what we get!</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>LOGISTIC REGRESSION:
Average training F1 score: 0.50095, Average validation F1 score: 0.50340, Overfit score: 1.98883</p><p>DECISION TREE
Average training F1 score: 0.91534, Average validation F1 score: 0.89280, Overfit score: 0.45129</p></div></div><p>Although this model looks great and doesn’t appear to be overfitting we are going to go with the model below that has been tuned with a lower maximum depth. Our goal is interpretability and a depth of 7 doesn’t really give us that. So we are sacrificing a little bit of accuracy for interpretability.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average training F1 score: 0.82174, Average validation F1 score: 0.81610, Overfit score: 0.74122</p></div></div><p>Great, so we now have a few potential models. We are going to move forward with the decision tree model as the logistic regression model isn’t quite up to scratch.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pruning-the-decision-tree">Pruning the Decision Tree<a class="hash-link" href="#pruning-the-decision-tree" title="Direct link to heading">​</a></h3><p>Although our model doesn’t appear to be overfitting, we are still going to prune the decision tree as it helps us get rid of sub-nodes that don’t have much predictive power. We do this with the hope that this helps our model generalize better. An added bonus, that tends to come with most regularization, is that it also helps improve the interpretability of the model.</p><p>We can prune our tree by picking the right cost complexity parameter. We will start by training a model on the whole dataset, with our chosen hyperparams, to find our space of <strong>α</strong>’s — the cost complexity parameter. We can then score each of these <strong>α</strong>’s in a cross-validated way to find the best complexity to choose.</p><p>We found that the value <strong>α</strong> = 0.00811411 is the best complexity to choose. In general, as <strong>α</strong> increases the number of nodes and depth decreases. So we pick the highest α value that still has a good average F1 score.</p><p>We can now train our final model!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-does-it-perform-on-test-data">How Does It Perform on Test Data<a class="hash-link" href="#how-does-it-perform-on-test-data" title="Direct link to heading">​</a></h3><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/predict.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> feature_pipeline</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> thresh</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Predict customer churn on new data</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param X: data containing features</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param clf: trained model</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param feature_pipeline: trained feature processing pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param thresh: prediction threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: predictions</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    '''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    X </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> feature_pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict_proba</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> thresh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> preds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df_test </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"data/external/test.csv"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df_test </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> preprocess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_test</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y_test </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_test</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_test</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">f1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> precision </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_test</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Average F1 = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">f1</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Recall = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">recall</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Precision = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">precision</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.77729, Recall = 0.65925, Precision = 0.94680</p></div></div><p>The model does well on the test data! We can see that the precision is a lot higher than the recall however but this is something that can be tuned by changing the prediction probability threshold. In our case, we are trying to get to 80% recall while maximizing precision.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="picking-the-optimal-probability-threshold">Picking the Optimal Probability Threshold<a class="hash-link" href="#picking-the-optimal-probability-threshold" title="Direct link to heading">​</a></h3><p>We can now tune the probability threshold to try and optimize our precision-recall trade-off. Let’s plot a precision-recall curve and find the optimal threshold to achieve 80% recall.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/precision_recall.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> PrecisionRecallDisplay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># training data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># precision recall curve</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">display </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> PrecisionRecallDisplay</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_estimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"Decision tree classifier"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> display</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ax_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_title</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Precision-Recall curve"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="recall" src="/PersonalWebsite/assets/images/precision_recall-caa96de7f5f5c2be9663c03532fd58f1.png" width="388" height="279" class="img_ev3q"></p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/optimize_threshold.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> precision_recall_curve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">optimize_threshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recall </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">'''</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Optimize prob. threshold on training dataset</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param df: pandas dataframe</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param recall: desired recall</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :return: optimal prob. threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    '''</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create features and target labels</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    X </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get scores for valid data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict_proba</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># locate where recall is closest to 0.80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    precisions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> recalls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> thresholds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> precision_recall_curve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    distance_to_optim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recalls </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> recall</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimal_idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argmin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">distance_to_optim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    thresh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> thresholds</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">optimal_idx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> thresh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thresh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> optimize_threshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thresh</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We get a threshold of 0.426. If we predict on our test set again then hopefully we will see something closer to our desired recall! And yes, I know I’ve committed the cardinal sin of using the test set twice but this was for demonstration purposes. The test set is normally a ‘one and done’ situation. Our final results are:</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Average F1 = 0.79584, Recall = 0.85185, Precision = 0.74675</p></div></div><p>Awesome! We have done what we wanted to do, and things work well! It’s also great to see test scores so similar to our earlier scores as it shows we haven’t overfitted our model. Let’s log this model on MLFLOW.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># log metrics on mlflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">with mlflow.start_run(run_name="Final Decision Tree") as mlops_run:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.log_metric("F1", f1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.log_metric("Recall", recall)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.log_metric("Preision", precision)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.log_params(params)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.log_params({"prob_thresh": 0.426})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # log model and pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.sklearn.log_model(clf, "clf")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mlflow.sklearn.log_model(features, "features_pipeline")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mlflow-experiment-session">MLFLOW Experiment Session<a class="hash-link" href="#mlflow-experiment-session" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="mlflow" src="/PersonalWebsite/assets/images/mlflow-911bee12339357fd21202de8dd94380b.png" width="1708" height="478" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="model-interpreting">Model Interpreting<a class="hash-link" href="#model-interpreting" title="Direct link to heading">​</a></h2><p>Tree-based models split the data multiple times according to certain cutoff values in the features. By splitting, different subsets of the dataset are created, where each instance belongs to a certain subset. To predict the outcome in each leaf node, the average outcome of the training data in this node is used.</p><p>The interpretation for decision trees is very easy: Starting from the root node, you go to the next nodes and the edges tell you which subsets you are looking at. Once you reach the leaf node, the node tells you the predicted outcome. All the edges are connected by ‘AND’.</p><p>So the general way we can predict is: If feature x is <strong>smaller</strong> (/bigger) than threshold c <strong>AND</strong> … then the predicted outcome is the most common value of the target of the instances in that node.
Let’s plot out the tree and see what we can infer!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/plot_model.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># get feature names</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">numeric_features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'total_charge'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'number_customer_service_calls'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'total_day_minutes'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'total_day_charge'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">'total_minutes'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'total_intl_calls'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'total_intl_minutes'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'number_vmail_messages'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'total_intl_charge'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary_features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'international_plan'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'voice_mail_plan'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">feature_names </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">numeric_features</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> binary_features</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># plot tree from our model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> graphviz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tree_graph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tree</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">export_graphviz</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> out_file</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              feature_names</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">feature_names</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              class_names</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'No churn'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Churn'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              filled</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rounded</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              special_characters</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">graph </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> graphviz</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Source</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tree_graph</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">graph</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="model" src="/PersonalWebsite/assets/images/model-05c504e24eb39a276f0676113850575a.png" width="1436" height="1002" class="img_ev3q"></p><p>Each node in the tree will give a condition and the left node below is True and the right node is False. The first split was performed with the total day minutes feature, which counts the total minutes of all calls made in the day. We can see for example that if the total minutes are less than 71 we follow the tree left and if the minutes are greater than 71 we go right.</p><p>Each prediction from the tree is made by following the tree down until a root node is hit. For example, if a customer has less than 71 total day minutes and their total charge is between 0.04 and 1 then we would predict them to churn.</p><p>We can see that the charge from the telecom provider seems to be a big distinguishing factor between customers and this is confirmed by the SHAP feature importance plot earlier. By following the tree left we can see that customers with a high day charge but low day minutes tend to churn more than stay. If the day charge is less than 3 however, the customers tend to stay no matter what the minutes are! One possible explanation for this could be that the customers churning are on mobile plans that don’t correctly suit their needs, this would need to be investigated further though.</p><p>Another interesting observation is that if a customer has a high total day minute (&gt;71) and they do not speak to customer service (&lt;0.965 calls i.e. no calls) they are more likely to churn than customers that do speak to customers service. Again, this would need further investigation to draw conclusions as to why this is true.
As with most data problems, it quite often leads to more questions to be answered!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>We have built an interpretable machine learning model that can identify customers that are likely to churn with our desired recall of 80% (we actually achieved 85% on the test set) and a precision of 75%. That is we identify 85% of the churned customers correctly and 75% of our churn predictions are accurate. Using this model we can then understand the key factors driving customers to leave and hopefully we can use this to try and keep more customers in the long run.</p><p>Thanks for reading and I hope you enjoyed it. If you have any comments or questions please feel free to reach out.</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="Classification" term="Classification"/>
        <category label="Imbalanced Classification" term="Imbalanced Classification"/>
        <category label="Scikit-Learn" term="Scikit-Learn"/>
        <category label="Optuna" term="Optuna"/>
        <category label="MLFlow" term="MLFlow"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Predicting Strava Kudos]]></title>
        <id>Strava-Kudos</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Strava-Kudos"/>
        <updated>2021-10-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[An end-to-end data science project, from data collection to model deployment, aimed at predicting user interaction on Strava activities based on the given activity’s attributes.]]></summary>
        <content type="html"><![CDATA[<p><strong>An end-to-end data science project, from data collection to model deployment, aimed at predicting user interaction on Strava activities based on the given activity’s attributes.</strong></p><p>Strava is a service for tracking human exercise which incorporates social network type features. It is mostly used for cycling and running, with an emphasis on using GPS data. A typical Strava post from myself is shown below and we can see that it contains a lot of information: distance, moving time, pace, elevation, weather, GPS route, who I ran with, etc., etc.</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/strava1-fdfa013a2c6b3f4732bc99c62f823a3b.png" width="1032" height="1246" class="img_ev3q"></p><p>Now, Strava is also a social media and each activity can be given kudos, which is the equivalent of likes on other platforms. So given that I’ve posted over 4000 activities on Strava, it was a great place to start a unique little data science project. My goal was to predict the number of kudos each activity gets based on the activity's attributes.</p><p>Predicting Kudos wasn't necessarily an easy task, however. Of the data points extracted from Strava, the mean Kudos count was 38 with a standard deviation of 24. The minimum was 0 and the maximum was 171. There is a lot of variability in the data… so hopefully we can create some useful features to help explain this!</p><p><img loading="lazy" alt="kudos" src="data:image/png;base64,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4MCB4XA4JyensLBQ7gCQNNrlDJiHDx+ORCJf/vKXS0tLx4wZc80110Sj0cRDGRkZJSUlcgcAZaIptbW1O3fufPrpp3v16vXVr361Z8+eDR8NhULNLqF//97ttMHNXg6jJSKRcIfN0yYr3FYL7Iob3uhznTexzUPuElJzqyUgBCG0RwjtUib+7M/+bOTIkf369QuC4Oabby4sLOzevXvioePHj2dkZDS7hLKyirq6eHuEVVp6uvULaXjNyYtpq3lav8JtlUBX3PBG1/m8q4a2echd5YMjBbdaAkIQQutDaLR2NPWdicWLFze8O2/evBY+05gxY15//fXy8vLa2trXXntt/PjxBw8ePHz4cG1t7ebNmzMzM3VAAEgaje+ZWLJkSUlJSXFx8cmTJxNTYrHYgQMHWrjQoUOH/v3f//0dd9xRU1MzevToGTNmfPKTn5w3b15VVVVWVtb48ePlDgBJXiamT5++f//+ffv2jRs3LjGle/fuw4cPb/lyp3+g/u7IkSNffPFFcQNAqpSJ6z4watSoK6+8UkYAwIcuEwlvv/12Xl7eqVOn4vH/+13ITZs2iQwAaGmZWLp06bRp04YMGdKSH3MCAMrE+SKRyF133SUjAKAJTf009Jprrtm3b5+MAIAmNLVn4siRI9OmTfvYxz6Wnp6emOI7EwDAhygTCxYsEBCdVt8reqanheUA0KnLxLXXXisgOq30tHDe481czn7l/CxBAVzOMjFixIhQKBSPxxO/5ohGo9u2bRMZANDSMvHWW28lbtTU1Lz88sv1dwEA6nVryUyRSGTixIlvvPGGvACA8zS1Z+L9999P3IjH47t37y4vL5cXAPAhykT9dyaCIOjfv/8DDzwgLwDgQ5QJX5IAAFpVJurq6p566qlt27bFYrHRo0fPmTMnHPazflJOS05oUVUdKz91VlaAMnG+73znO2+99dadd95ZV1f37LPPrlixYvHixSIj1TihBcCll4nXXnvt+eefj0QiQRD89V//9a233qpMAAAfokzE4/FEkwiCIC0trf42XU7DHfXRaJ9G57GjHoC2LxODBw9etmzZF7/4xSAInnnmGWfX7rrqd9RHIuGamlij89hRD8ClaeqkVUuWLCkvL8/Nzb399tvfe++9Bx98UF4AQIvKRHV19cKFC998883ly5cXFRV95jOf6d69e+/eveUFALSoTKxZ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x0bSe+edd+o/FoIg6Nev3yWPBBf6AgBaxRkwAQBlAgBQJgAAZQIAUCYAAJQJAECZADrIL3/5yw91nomlS5d+97vf7Tzrv2vXrm984xteR1AmAC7R7373u5S6WhsoE0DntXPnzjFjxvzgBz+o31FRv9OioqJi/vz548aNmzlz5oEDBxKP7t+/f+bMmTk5ObfeemtBQUHikoP33XffbbfdNmXKlPz8/Itd2byysnLRokXjxo2bMGHCY489Fo/HT58+/bWvfW3SpEk5OTkrVqyIxWJBEPzFX/zFyZMnE/8kcfuXv/xlbm5uXl7e5MmTJ0yY8Oabbx47dmzNmjU7d+5ctGiRVxCUCeByevPNNxctWvT9739/+PDhFz66Zs2aHj16FBYWPv744wcPHgyCIBaLfeUrX5k5c+amTZuefPLJxx577De/+c0rr7xSWVn505/+NHGtoCNHjjT6XGvWrKmqqtqyZUtBQcGvf/3rHTt2PPzwwx/5yEc2bdr0/PPP79u3L3Ga50bt2rVr9uzZBQUF06dPf+KJJz760Y/ed999N9xww6OPPupFBGUCuGz+8Ic/zJkz52/+5m8GDx7c6Azbt2+fPHlyKBTq169f4to/hw4dqqqqys7OTlz7Jjs7+7XXXrv++ut/97vfzZw585//+Z/vvPPOQYMGNbq0oqKi6dOnd+/ePS0t7Zlnnrnxxhu3bdv2xS9+MRQKpaWl5ebmbtu27WKr+rGPfezTn/50EARDhgw5deqU1w6UCaBT6N69+49+9KONGzfu2rUrFPr/1+upqampn6d+Yvfu3YMgOO8QRjwej8ViAwcOfOWVV+6+++6Kioq77rqrsLCw0acLh8OhUChx+9ixY++9917DpdXV1SUOc9Srrq6uv92jR4/EjYbrCSgTwGUWjUY/+9nPLly4MC8vr1+/fkePHi0rK4vH4z/72c8SM3z+85/fsGFDXV3dqVOnfv7znwdBcPXVV0cikZdffjkIgpKSkpdeemnUqFH/9m//tmjRoptuuikvL++mm27av39/o083cuTIjRs31tXVVVdX33fffb/61a9uuummdevWxePx6urq9evXjxo1KnEBw//6r/8KguCVV15pugmdVz4AZQK4PKZMmXL11Vc//fTTubm506ZNu/3226PRaOKhefPmhcPhW265Zc6cOddee20QBJFIZO3atf/6r/+ak5Nz1113zZ07d8SIEZMnT66trZ0wYcLUqVMrKioudjnve++9NxKJ3HbbbZMnT87KysrOzs7Pzz958mTOB66++uo5c+YEQZCfn7906dIpU6bs2bOnfk0uNHz48AMHDsydO9crCJeRXYUAQKuERQC0hwMHDixYsOC8iVdfffU//dM/CQeSjD0TAECr+M4EAKBMAADKBACgTAAAygQAwIf0fwIAAP//AdSz+8N13YcAAAAASUVORK5CYII=" width="708" height="348" class="img_ev3q"></p><p>If you want to fast forward to the end project, you can find the finished product <a href="http://strava-kudos.herokuapp.com/" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-collection">Data Collection<a class="hash-link" href="#data-collection" title="Direct link to heading">​</a></h2><p>Strava has a feature that allows the user to download all of their previous data, however, this can only be done once a week. A much better solution for data collection was to use the Strava API which allows you to make 100 requests every 15 minutes, and a total of 1000 daily i.e. more than enough calls for our intended goal.</p><p>Using this <a href="https://developers.strava.com/docs/reference/" target="_blank" rel="noopener noreferrer">API</a>, I was able to efficiently gather all my activity data very quickly. Lovely. Another benefit of this API was that it allowed me to extract my most recent activities so that I could predict kudos on the fly, which was one of the end goals for this project. A GIF of this real-time Kudos prediction on my Streamlit app can be seen below.</p><p><img loading="lazy" alt="gif" src="/PersonalWebsite/assets/images/streamlit-44fabf87fc9b178e667c735881e01516.gif" width="600" height="282" class="img_ev3q"></p><p>If you're interested in getting started with the Strava API, I would highly recommend that you start with <a href="https://medium.com/r?url=https%3A%2F%2Ftowardsdatascience.com%2Fusing-the-strava-api-and-pandas-to-explore-your-activity-data-d94901d9bfde" target="_blank" rel="noopener noreferrer">this blog post</a>.</p><p>Once I had set things up and had the required keys, getting recent activities was easy!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/strava_api.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_recent_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get payload information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://www.strava.com/oauth/token"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activites_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://www.strava.com/api/v3/athlete/activities"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"client_id"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"XXXX"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"client_secret"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"XXXX"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"refresh_token"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"XXXX"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"grant_type"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"refresh_token"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"f"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"json"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># check if there is a new request token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">auth_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verify</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"access_token"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Authorization"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Bearer "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> access_token</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialise dataframe with first few activities</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"per_page"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> recent</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"page"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activites_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">param</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json_normalize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">my_dataset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># keep useful features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    columns_to_keep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kudos_count"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"distance"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"moving_time"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> activities</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">columns_to_keep</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> activities</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>By simply adding a while loop to this code, it was easy to get all the Strava data I needed for my project!</p><table><thead><tr><th>name</th><th>distance</th><th>moving_time</th><th>total_elevation_gain</th><th>workout_type</th><th>kudos_count</th><th>max_speed</th><th>average_heartrate</th><th>max_heartrate</th><th>pr_count</th><th>suffer_score</th><th>is_named</th><th>local_date</th><th>run_per_day</th><th>max_run</th><th>run_area</th><th>average_speed_mpk</th><th>datetime</th><th>hour</th><th>uk_awake</th></tr></thead><tbody><tr><td>Plastic bag floating in the wind</td><td>16.1041</td><td>75.0</td><td>181.2</td><td>0.0</td><td>45</td><td>5.4</td><td>144.0</td><td>165.0</td><td>0</td><td>33.0</td><td>1</td><td>2021-09-09</td><td>1</td><td>1</td><td>12.377207167446613</td><td>4.656607991058955</td><td>2021-09-09 13:57:28</td><td>13</td><td>1</td></tr><tr><td>Cake loop 🎂</td><td>21.0416</td><td>99.05</td><td>346.9</td><td>0.0</td><td>54</td><td>5.0</td><td>151.0</td><td>167.0</td><td>1</td><td>83.0</td><td>1</td><td>2021-09-08</td><td>1</td><td>1</td><td>84.87930754199624</td><td>4.706580062129342</td><td>2021-09-08 13:43:26</td><td>13</td><td>1</td></tr><tr><td>Doublé</td><td>8.0736</td><td>38.78333333333333</td><td>92.0</td><td>0.0</td><td>30</td><td>4.4</td><td>137.7</td><td>161.0</td><td>0</td><td>12.0</td><td>1</td><td>2021-09-07</td><td>2</td><td>0</td><td>4.8462999984622</td><td>4.802881844380403</td><td>2021-09-07 20:07:54</td><td>20</td><td>0</td></tr><tr><td>Moderate beanage🐘</td><td>19.607200000000002</td><td>87.51666666666667</td><td>23.0</td><td>3.0</td><td>52</td><td>7.3</td><td>142.9</td><td>191.0</td><td>0</td><td>44.0</td><td>1</td><td>2021-09-07</td><td>2</td><td>1</td><td>6.491399835795164</td><td>4.463310123192287</td><td>2021-09-07 13:12:26</td><td>13</td><td>1</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploratory-data-analysis-eda">Exploratory Data Analysis (EDA)<a class="hash-link" href="#exploratory-data-analysis-eda" title="Direct link to heading">​</a></h2><p>Once I had all the data, the next thing on the agenda was some EDA. This involved exploring the data, looking at distributions, correlations, and general information about different features. The notebook I created for this can be found on <a href="https://github.com/jackmleitch/StravaKudos" target="_blank" rel="noopener noreferrer">my Github page</a>.</p><p>Some notable findings include:</p><ul><li>The Kudos received depends heavily on how many followers I had at the time. Unfortunately, there was no way to see how many followers I had at each point in time so I was unable to weight the Kudos with respect to follower count. I therefore could only use my most recent 1125 activities (from Dec 2019 to present) to train my model as the kudos stayed fairly consistent in this interval.</li></ul><p><img loading="lazy" alt="kudos_time" src="/PersonalWebsite/assets/images/kudos_time-72495e01f665abd3f5efc38e511a819d.png" width="388" height="262" class="img_ev3q"></p><ul><li><p>It was found that the target variable (Kudos) is skewed right (also bimodal) and there are some extreme values above ~100. When using certain models, for example, linear regression, would like to see more of a normal distribution in the target variable. A BoxCox transform could therefore be used to see a more ‘normal-looking’ distribution in the target variable (normality can then be checked by plotting a q-q plot, for example).</p></li><li><p>An <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.IsolationForest.html" target="_blank" rel="noopener noreferrer">isolation forest model</a> was used to detect outliers and out of the 800 training points, 17 outliers were found. Upon further investigation, these were predominantly activity uploads that were initially set to private but then switched to public at a later date. This meant that other users couldn't see or interact with the activity. These were removed from the training set.</p></li><li><p>Features such as distance, moving_time, and average_speed_mpk seem to share a similar distribution to the one we have with kudos_count. This was confirmed when looking at a correlation matrix.</p></li><li><p>The photo count feature only has a few different data points in each nonzero category so we can change this to a binary feature of contains photos/no photos.</p></li><li><p>Workout type seems to correlate strongly with Kudos, however, there aren't that many data points for workout type 1 (a race). Intuitively, I also believe that races receive more Kudos in general. <a href="https://imbalanced-learn.org/stable/references/generated/imblearn.over_sampling.SMOTE.html" target="_blank" rel="noopener noreferrer">SMOTE</a> was therefore used to oversample this workout type to give more predictive power to this feature and it was later found that this reduced the RMSE.</p></li><li><p>By looking at time distribution between activities, it was found that runs that are quickly followed in succession by other runs tend to receive less kudos than runs that were the only activity that day. To add to this, the longest activity of the day tends to receive more kudos than the other runs that day.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preprocessing">Preprocessing<a class="hash-link" href="#preprocessing" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="train-test-and-cross-validation">Train, Test, and Cross-Validation<a class="hash-link" href="#train-test-and-cross-validation" title="Direct link to heading">​</a></h3><p>I first needed to split my dataset into a train and test set. I used an 80/20 split and as my data contained dates, I just used the most recent 20% of data as the test set. I did not want to randomly shuffle the dataset as I created some time-based features.</p><p>It is extremely important to have a good cross-validation scheme in which validation data is representative of training and real-world data, as it makes the model you build highly generalizable. Now, because I only had a small number of training examples, it would be prohibitive to have both validation and test sets. Cross-validation was therefore used on the training set to simulate a validation set.</p><p>I split the training set into 5 folds using Sklearn’s <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedKFold.html" target="_blank" rel="noopener noreferrer">StratifiedKFold</a>, where <a href="https://www.statology.org/sturges-rule/" target="_blank" rel="noopener noreferrer">Sturge’s rule</a> was used to calculate the appropriate number of bins.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/create_folds.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_folds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create a new col kfold and fill with -1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"kfold"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># randomize the rows of the data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sample</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frac</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Sturge's rule to calc bins</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_bins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">floor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># bin targets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"bins"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"kudos_count"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bins</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">num_bins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> labels</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initiate kfold class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_selection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StratifiedKFold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_splits</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fill the new kfold col</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">v_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kfold"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># drop bins col</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">drop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"bins"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># return df with folds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using this cross-validation scheme I was able to confidently compare different models to select the most promising models without worrying about overfitting the validation sets. This scheme was also used to tune the hyperparameters of the promising models (the folds were reshuffled before hyperparameter tuning though). It is worth noting that the only time the model was evaluated on the test set was right at the end of the project when I wanted to get a real gauge of the true performance.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="missing-values">Missing Values<a class="hash-link" href="#missing-values" title="Direct link to heading">​</a></h3><p>There was not a huge amount of missing values in the dataset, and most of the missing values came from features that are fairly new to Strava/features I didn't always use. For example, the workout_type feature didn't always have a ‘race’ option (which turned out to have a lot of predicting power!). Before imputing missing values, it's always really important to first investigate missing values and try to find out if there is a reason why they are missing, it might be important!</p><p>After some inspection, I manually entered some missing values for workout_type as I believed this to be very important and some older data didn’t have labels. I chose to manually enter the values as any simple imputation technique would've assigned all the missing values to the default Strava category of ‘easy run’. A KNN imputer was also considered but there weren't many unlabeled data points so manual entry was quicker.</p><p>A heuristic function was also used to fill in activities with titles that contain race positions e.g. 10th or 1st, as these activities were obviously races. This was done because races seemed to always have a big influence on Kudos.</p><p>The general imputation scheme used on the whole dataset was:</p><ul><li><p>Any missing values in a categorical feature were just assigned a new category ‘NONE’ — this seems to work well most of the time when dealing with missing categories.</p></li><li><p>All missing values in numeric features were imputed using the median strategy (mean was also tried but median worked better).</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-preprocessing">Other Preprocessing<a class="hash-link" href="#other-preprocessing" title="Direct link to heading">​</a></h3><p>Other data preparation steps included: dropping activities that weren't runs, dropping activities that had no Kudos (mostly because run would've been on private and then switched to public), and formatting DateTime information.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="feature-engineering">Feature Engineering<a class="hash-link" href="#feature-engineering" title="Direct link to heading">​</a></h2><p>Feature engineering is one of the most crucial parts of building a good machine learning model. If we have useful features, the model will perform better.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-based-features">Time-Based Features<a class="hash-link" href="#time-based-features" title="Direct link to heading">​</a></h3><p>We have date and time data for each activity so we can easily make some trivial time-based features. Some of these features include year, week of the year, month, day of the week, time of day, weekend, etc.</p><p>From experience, I also know that the more activities I post on Strava a day the fewer kudos I tend to receive so I can try to incorporate this into a few features too. The features I made to encapsulate this:</p><ul><li>max_run (binary) — is the activity the longest in distance of that day?</li><li>run_per_day (ordinal) — how many total activities were done that day.</li></ul><p>I am from the U.K. but I am currently studying in Boise, Idaho so the majority of my friends/followers are from the U.K. To try to account for this, I made a binary feature ‘is_uk_awake’ that checks if the U.K. is awake when that activity was uploaded. I generally find that posting an activity outside of this time window results in fewer kudos.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-features">Other Features<a class="hash-link" href="#other-features" title="Direct link to heading">​</a></h3><ul><li><p>Runs that are left with default names such as ‘Afternoon Run’ tend to get less interaction than runs that have custom names. A binary feature was thus created to check if the run was named or not.</p></li><li><p>I’ve always had an intuition that runs with really nice aesthetic GPS traces tend to receive more attention than runs that don't. To try to encapsulate this into a feature I used the runs GPS trace to workout the area enclosed by the run loop (an out and back run will return a value of 0). My idea is that bigger loops get more Kudos than smaller loops or out and back runs.</p></li><li><p>Some other features were added and can be found in my code on Github.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-encoding">Feature Encoding<a class="hash-link" href="#feature-encoding" title="Direct link to heading">​</a></h3><p>One-hot-encoding was used to encode categorical features and ordinal encoding was used to encode ordinal features (categorical features where the order means something).</p><p>The workout-type feature seemed to struggle with predictive power even though I know it is a very helpful and correlated feature, it might have something to do with the uneven distribution of categories. So to help it out I used target encodings. We need to be very careful here though as this might overfit the model. Target encoding is a technique in which you map each category in a given feature to its mean target value, but this needs to always be done in a cross-validated manner!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/target_encoding.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mean_target_encoding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># list categorical columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat_cols </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"workout_type"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"is_named"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we label encode all the features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> col </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> cat_cols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># initialise label encoder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lbl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> preprocessing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LabelEncoder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># fit label encoder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lbl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># transform all of the data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> col</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lbl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># a list to store 5 validation dataframes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoded_dfs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># loop over every fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> fold </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get training and validation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        df_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        df_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># for all cat columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> column </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> cat_cols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># create dict of category:mean target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mapping_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">groupby</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"kudos_count"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># column_enc is the new column we have with mean encodings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            df_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> column </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"_enc"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapping_dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># append to our list of encoded validation dfs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        encoded_dfs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create full dataframe again and return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    encoded_df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">concat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">encoded_dfs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> encoded_df</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-scaling">Feature Scaling<a class="hash-link" href="#feature-scaling" title="Direct link to heading">​</a></h3><p>Finally, we need to consider scaling. As a rule of thumb, when we use a model that computes distance like K.N.N or assumes normality like linear regression, we need to scale our numeric features. Typically, we use either <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.MinMaxScaler.html" target="_blank" rel="noopener noreferrer">min-max scaling</a> or <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.StandardScaler.html" target="_blank" rel="noopener noreferrer">standardization</a> and to figure out which to use we just have to try both and see which results in the best performance. Tree-based models, however, are not distance-based and can handle varying ranges of features, and hence scaling is not required.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="modeling">Modeling<a class="hash-link" href="#modeling" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="initial-model-selection">Initial Model Selection<a class="hash-link" href="#initial-model-selection" title="Direct link to heading">​</a></h3><p>In this step, I built a few different candidate models and compared different metrics to determine which was the best model for deployment. Model performances and features used were saved in a CSV file to help keep track of which model was performing the best. It is very important when comparing models to train and evaluate in a cross-validated manner!</p><p>The training script I used is shown below (note: some things were removed to declutter, e.g. target encodings, etc.).</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scale_features</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># read training data with folds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">STRAVA_TRAIN_KFOLD_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># list all features</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_cols </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"distance"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"average_speed_mpk"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"suffer_score"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat_cols </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"max_run"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"workout_type"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># all cols are features except for target and kfold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_cols </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> cat_cols</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fill cat column NaN values with NONE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> col </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> cat_cols</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> col</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fillna</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"NONE"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># training data is where kfold is not equal to fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kudos_count</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># validation data is where kfold = fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kudos_count</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># pipelines for model transformation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> scale_features</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"imputer"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> impute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SimpleImputer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strategy</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"median"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"std_scaler"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preprocessing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StandardScaler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"imputer"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> impute</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SimpleImputer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strategy</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"median"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cat_pipeline </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Pipeline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"cat"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preprocessing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OneHotEncoder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle_unknown</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"ignore"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># transforms columns and drops columns not specified</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">num_cols</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train_cat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cat_pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit_transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cat_cols</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">num_cols</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid_cat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cat_pipeline</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">cat_cols</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># join numeric data and categorical data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hstack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train_num</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x_train_cat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"csr"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hstack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid_num</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x_valid_cat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">format</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"csr"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialize model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_dispatcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fit model on training data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># predict on validation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    valid_preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get rmse, and mape</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rmse </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean_squared_error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_preds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> squared</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_error </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valid_preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Fold = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, rmse = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rmse</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, max error = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">max_error</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_valid</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rmse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Some shortlisted models that performed well were: <a href="https://xgboost.readthedocs.io/en/latest/python/python_api.html" target="_blank" rel="noopener noreferrer">XGBoost</a>, <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.Lasso.html" target="_blank" rel="noopener noreferrer">Lasso</a>, and <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html" target="_blank" rel="noopener noreferrer">Random Forest</a>. These models were then taken forward to the feature selection stage.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="feature-selection">Feature Selection<a class="hash-link" href="#feature-selection" title="Direct link to heading">​</a></h3><p>Feature selection was then performed to help reduce the dimensionality of the dataset with the hope that this creates a more generalizable model, we've all heard of the <a href="https://towardsdatascience.com/the-curse-of-dimensionality-50dc6e49aa1e" target="_blank" rel="noopener noreferrer">curse of dimensionality</a>.</p><p>Different feature selection techniques were used for the different models. For example, we did not need to do much selection for the Lasso model. When trying to minimize the cost function, Lasso regression will automatically select those features that are useful, discarding the useless or redundant features. Therefore, all we needed to do was remove features with coefficients equal to zero.</p><p>With the tree-based models, the final methodology used a combination of <a href="https://towardsdatascience.com/a-novel-approach-to-feature-importance-shapley-additive-explanations-d18af30fc21b" target="_blank" rel="noopener noreferrer">Shapley values</a> and the built-in feature importance values. Although, care needs to be taken when looking at the feature importance from tree-based models which you can read more about it <a href="https://towardsdatascience.com/be-careful-when-interpreting-your-features-importance-in-xgboost-6e16132588e7" target="_blank" rel="noopener noreferrer">here</a>.</p><p>PCA was also trialed to help combat the dimensionality but it did not improve the model performance or generalizability. One reason might be that the feature space was only reduced by 2 when accounting for 90% of the variance.</p><p>The final features chosen were: distance, average speed, max run (was the run the longest run of the day), workout type (+target encodings), total elevation gain, moving time, suffer score, run per day (number of runs that day), max speed, run area (area enclosed by GPS trace), and UK awake (was the UK awake when activity was posted?).</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/feature_imp-d45c45f8d4c839d97ccb79512f21cfe5.png" width="1400" height="1073" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hyperparameter-tuning">Hyperparameter Tuning<a class="hash-link" href="#hyperparameter-tuning" title="Direct link to heading">​</a></h3><p><a href="https://optuna.org/" target="_blank" rel="noopener noreferrer">Optuna</a> was used to tune all three shortlisted models, an open-source framework that is very easy to use and incredibly good. In particular, the Tree-structured Parzen Estimator (TPE) was used to sample the parameter space, which uses Bayesian reasoning to construct a surrogate model and can select the next hyperparameters using <a href="http://krasserm.github.io/2018/03/21/bayesian-optimization/#:~:text=Expected%20improvement%20is%20defined%20as,if%20%CF%83(x)%3D0" target="_blank" rel="noopener noreferrer">Expected Improvement</a>. A good tutorial on hyperparameter tuning with Optuna can be found <a href="https://medium.com/subex-ai-labs/efficient-hyperparameter-optimization-for-xgboost-model-using-optuna-3ee9a02566b1" target="_blank" rel="noopener noreferrer">here</a>.</p><p>The code I used to tune my XGB model is shown below.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/tune_hyperparameters/py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">objective</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_jobs</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> random_state</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># read in the data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"input/data_train.csv"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># prepare data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kudos_count"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kudos_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># stratisfied kfold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_folds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># define parameter search space for XGB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"tree_method"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"gpu_hist"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"verbosity"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 0 (silent) - 3 (debug)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"objective"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reg:squarederror"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"n_estimators"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"n_estimators"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"max_depth"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"max_depth"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"learning_rate"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"learning_rate"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.005</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.05</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"colsample_bytree"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"colsample_bytree"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"subsample"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"subsample"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"alpha"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"alpha"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"lambda"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"lambda"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"gamma"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"lambda"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"min_child_weight"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> trial</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">suggest_loguniform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"min_child_weight"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"seed"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> random_state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"n_jobs"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> n_jobs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># add pruning callback which prunes unpromising trials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pruning_callback </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> XGBoostPruningCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"validation_0-rmse"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># scores for each fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># everything is a feature apart from the target and kfold col</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    features </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">f </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> f </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">columns </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> f </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"kudos_count"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kfold"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># loop over each fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> fold </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># training data is where kfold is not equal to fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kudos_count</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_train</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># validation data is where kfold = fold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kudos_count</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_valid</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># initialize model and fit on data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xgb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XGBRegressor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            y_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            eval_set</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            early_stopping_rounds</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            verbose</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callbacks</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pruning_callback</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># predict and score model on validation set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean_squared_error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> squared</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># return average rmse across the 5 folds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> score</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialize Optuna TPE sampler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sampler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TPESampler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create study in which we minimize rmse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    study </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_study</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">direction</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"minimize"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sampler</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">sampler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># optimize hyperparams on XGB model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    study</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optimize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objective</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_trials</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># display params</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    best </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> study</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">best_params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> best</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">key</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">&gt;20s</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> : </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">value</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation string" style="color:#e3116c">'best objective value'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">&gt;20s</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> : </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">study</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">best_value</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># save best hyperparams</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"models/production/xgb_params.pickle"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wb"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pickle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">best</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The optimization history plot below shows how quickly the TPE sampler converges to the optimal hyperparameters. The two other plots show the importance of each hyperparameter and the high-dimensional parameter relationships, respectively.</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/hyper1-b471ae01e956b0b5edf9ef62af1c7f68.png" width="905" height="450" class="img_ev3q">
<img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/hyper2-5a3acfa811b57f9961b030cb638eeafe.png" width="905" height="450" class="img_ev3q">
<img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/hyper3-9ba5015b649a43245652f9d6513ba167.png" width="905" height="450" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="model-selection">Model Selection<a class="hash-link" href="#model-selection" title="Direct link to heading">​</a></h3><p>After performing the hyperparameter tuning, it was found that the XGB model consistently outperformed the other two shortlisted models. As seen in the table below, the average RMSE over 5 folds was lower. It was also found that the variance of the error was lower. From this, I concluded that with the data I had, the XGB model was more likely to generalize better to unseen data.</p><table><thead><tr><th>Model</th><th>Fold 1</th><th>Fold 2</th><th>Fold 3</th><th>Fold 4</th><th>Fold 5</th><th>Mean</th><th>Variance</th></tr></thead><tbody><tr><td>XGBRegressor</td><td>9.12</td><td>9.47</td><td>9.33</td><td>9.59</td><td>9.54</td><td>9.41</td><td>0.036</td></tr><tr><td>RandomForestRegressor</td><td>10.51</td><td>10.94</td><td>11.09</td><td>11.16</td><td>10.75</td><td>10.89</td><td>0.070</td></tr><tr><td>Lasso</td><td>9.78</td><td>9.99</td><td>10.93</td><td>11.04</td><td>10.96</td><td>10.54</td><td>0.36</td></tr></tbody></table><p>The final XGB model was then trained on the <strong>whole</strong> training dataset using the hyperparameters found earlier.</p><p>It was comforting to see that when these three models were used to predict on the test dataset, the XGB model outperformed both other models. Disclaimer: this was (and needs to be) done after model selection, you don't want to overfit the test set! The test set scores were 9.78, 11.83, and 10.68 for XGB, RF, and Lasso, respectively.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">​</a></h2><p>The model, along with some other features, was deployed using Streamlit and Heroku. Tutorials on Streamlit and Heroku can be found <a href="https://towardsdatascience.com/build-your-first-interactive-data-science-web-app-with-streamlit-d4892cbe4792" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://towardsdatascience.com/a-quick-tutorial-on-how-to-deploy-your-streamlit-app-to-heroku-874e1250dadd" target="_blank" rel="noopener noreferrer">here</a>. An interface was built in which you could predict on my real-time Strava data, explore the model explainability, and explore the dataset. The app can be found <a href="http://strava-kudos.herokuapp.com/" target="_blank" rel="noopener noreferrer">here</a> (it may take a minute or so to boot up, apologies).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="model-explainability">Model Explainability<a class="hash-link" href="#model-explainability" title="Direct link to heading">​</a></h2><p>The final part of this project was investigating the model to try and see, in general, what attributes caused activities to get more/fewer kudos.</p><p>Interpreting XGBoost models is a notoriously hard task but with the combination of a solid theoretical backing and a fast practical algorithm, SHAP values are an incredibly powerful tool for confidently interpreting tree-based models.</p><p>The mean SHAP values for the final features can be seen below.
<img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/shap-e3d5fc7ad6d6e755a1c41d40e763a048.png" width="1400" height="1073" class="img_ev3q"></p><p>We can see that the distance feature is actually the most important, followed by the max_run feature (which is great to see as this is a feature I created!). Because SHAP gives us individualized explanations for every activity, we can do more than just make a bar chart. We can see how each feature affects the final Kudos value:
<img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/shap2-d895628f3c0622c8454aad37103920fe.png" width="1400" height="1093" class="img_ev3q"></p><p>The color in this plot represents the feature value — red indicating high and blue indicating low. So we can see that longer faster runs get more Kudos. More effort (higher heart rate and suffer score) also results in higher Kudos. On the other hand, easy runs get fewer Kudos than workouts, long runs, and races.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="closing-thoughts">Closing Thoughts<a class="hash-link" href="#closing-thoughts" title="Direct link to heading">​</a></h2><p>So there we go, a unique and successful data science project has been finished. Well, kind of… just because we have built a good model doesn't mean the model is always going to be a good one, it might drift.</p><p>Model drift refers to the degradation of model performance due to changes in data and relationships between input and output variables. So its important to check in every and then to see if the model is still performing at an adequate level. Maybe this is a topic for a future blog though.</p><p>Thanks for reading and I hope you enjoyed it. If you have any comments or questions please feel free to reach out.</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="Regression" term="Regression"/>
        <category label="Scikit-Learn" term="Scikit-Learn"/>
        <category label="Optuna" term="Optuna"/>
        <category label="XGBoost" term="XGBoost"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Building a Recipe Recommendation System]]></title>
        <id>Recipe-Recommendation</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Recipe-Recommendation"/>
        <updated>2021-07-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Using Word2Vec, Scikit-Learn, and Streamlit]]></summary>
        <content type="html"><![CDATA[<p><strong>Using Word2Vec, Scikit-Learn, and Streamlit</strong></p><p>First things first, If you would like to play around with the finished app. You can here: <a href="https://share.streamlit.io/jackmleitch/whatscooking-deployment/streamlit.py" target="_blank" rel="noopener noreferrer">https://share.streamlit.io/jackmleitch/whatscooking-deployment/streamlit.py</a>.</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/app-b4b868e72b5712f9ec9ec9e0ee050eb6.png" width="1134" height="801" class="img_ev3q"></p><p>In a previous blog post (Building a Recipe Recommendation API using Scikit-Learn, NLTK, Docker, Flask, and Heroku) I wrote about how I went about building a recipe recommendation system. To summarize: I first cleaned and parsed the ingredients for each recipe (for example, 1 diced onion becomes onion), next I <strong>encoded each recipe ingredient list using TF-IDF</strong>. From here I applied a similarity function to find the similarity between <strong>ingredients for known recipes and the ingredients given by the end-user</strong>. Finally, we can get the top-recommended recipes according to the similarity score.</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/flowchart-55db802e3605933d0b683dc6d533f488.png" width="1347" height="925" class="img_ev3q"></p><p>However, after using my new API for a while I wanted to improve on two things:</p><ol><li><p>Sometimes the ingredients in the recommendations didn't line up well with the input ingredients, so I needed some better embeddings.</p></li><li><p>The Flask API was well in need for a good makeover.</p></li></ol><p>Enter Gensim’s <strong>Word2Vec</strong> and <strong>Streamlit</strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preprocessing-and-parsing-of-ingredients">Preprocessing and Parsing of Ingredients<a class="hash-link" href="#preprocessing-and-parsing-of-ingredients" title="Direct link to heading">​</a></h2><p>To understand the task at hand here, let’s look at an example. The delicious ‘Gennaro’s classic spaghetti carbonara’ recipe found on Jamie Oliver’s <a href="https://www.jamieoliver.com/recipes/pasta-recipes/gennaro-s-classic-spaghetti-carbonara/" target="_blank" rel="noopener noreferrer">website</a> requires the ingredients:</p><ul><li><p>3 large free-range egg yolks</p></li><li><p>40 g Parmesan cheese, plus extra to serve</p></li><li><p>1 x 150 g piece of higher-welfare pancetta</p></li><li><p>200 g dried spaghetti</p></li><li><p>1 clove of garlic</p></li><li><p>extra virgin olive oil</p></li></ul><p>There is a lot of redundant information here; for example, weights and measures are not going to add value to the vector encodings of the recipe. If anything, it is going to make distinguishing between recipes more difficult. So we need to get rid of those. A quick google search led me to a <a href="https://en.wikibooks.org/wiki/Cookbook:Units_of_measurement" target="_blank" rel="noopener noreferrer">Wikipedia page</a> containing a list of standard cooking metrics e.g. clove, gram (g), teaspoon, etc. Removing all these words in my ingredient parser worked really well.</p><p>We also want to remove stop words from our ingredients. In NLP ‘stop words’ refer to the most common words in a language. For example, the sentence ‘learning about what stop words are’, becomes, ‘learning stop words’. NLTK provides us with an easy way to remove (most of) these words.</p><p>There are also other words in the ingredients that are useless to us — these are the words that are very common among recipes. Oil, for example, is used in most recipes and will provide little to no distinguishing power between recipes. Also, most people have oil in their homes so having to write oil every time you use the API is cumbersome and pointless. There are advanced NLP techniques, for example using <a href="https://open.blogs.nytimes.com/2015/04/09/extracting-structured-data-from-recipes-using-conditional-random-fields/" target="_blank" rel="noopener noreferrer">conditional random fields</a> (a class of statistical modeling), that can calculate the probability that a word is an ingredient, as opposed to a measure, texture, or another type of word that surrounds the ingredient word. But, simply removing the most common words seemed to be very effective, so I did this. Occam’s razor and all that jazz… To get the most common words we can do the following:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/get_word_freq.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> nltk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vocabulary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nltk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FreqDist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This was done once I had already preprocessed the ingredients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ingredients </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredients</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vocabulary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> frequency </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> vocabulary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">most_common</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">word</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">frequency</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">'</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have one final obstacle to get over, however. When we try to remove these ‘junk’ words from our ingredient list, what happens when we have different variations of the same word? What happens if we want to remove every occurrence of the word ‘pound’ but the recipe ingredients say ‘pounds’? Luckily there is a pretty trivial workaround: <strong>lemmatization</strong> and <strong>stemming</strong>. Stemming and lemmatization both generate the root form of inflected words — the difference is that a stem might not be an actual word whereas, a lemma is an actual language word. Although lemmatization is often slower, I chose to use this technique as I know the ingredients will be actual words which is useful for debugging and visualization (the results turned out to be practically identical using stemming instead). When the user feeds ingredients to the API we also lemmatize those words as the lemmatized words are the words with the corresponding vectorizations.</p><p>We can put this all together in a function, <code>ingredient_parser</code>, along with some other standard preprocessing: getting rid of punctuation, removing accents, making everything lowercase, getting rid of Unicode.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/parse_ingredients.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ingredient_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># measures and common words (already lemmatized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    measures </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'teaspoon'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'t'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'tsp.'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'tablespoon'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'T'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    words_to_remove </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'fresh'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'oil'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'a'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'red'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'bunch'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Turn ingredient list from string into a list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">literal_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># We first get rid of all the punctuation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    translator </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maketrans</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">punctuation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialize nltk's lemmatizer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lemmatizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> WordNetLemmatizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingred_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> ingredients</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">translate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">translator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># We split up with hyphens as well as spaces</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">' |-'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get rid of words containing non alphabet letters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isalpha</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Turn everything to lowercase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># remove accents</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">unidecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unidecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Lemmatize words so we can compare words to measuring words</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lemmatizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lemmatize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get rid of stop words</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop_words </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stopwords</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">words</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'english'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> stop_words</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Gets rid of measuring words/phrases, e.g. heaped teaspoon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> measures</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get rid of common easy words</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> words_to_remove</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ingred_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">' '</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ingred_list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When parsing the ingredients for ‘Gennaro’s classic spaghetti carbonara’ we get: egg yolk, parmesan cheese, pancetta, spaghetti, garlic. Perfect, that works fantastically! Using <code>df.apply</code> when can easily parse the ingredients for each recipe.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="word-embeddings-using-word2vec">Word Embeddings Using Word2Vec<a class="hash-link" href="#word-embeddings-using-word2vec" title="Direct link to heading">​</a></h2><p>Word2Vec is a 2-layer neural network that produces word embeddings. It takes in a corpus of text as an input (a collection of individual documents) and maps each word to a vector in Euclidean space. The end goal is to have a text representation that captures <strong>distributional similarities</strong> between words. That is, words that often appear in similar contexts are mapped to vectors separated by a shorter Euclidean distance (the L2 norm).</p><p>In the context of recipe ingredients, Word2vec allowed me to capture similarities between recipe ingredients that are commonly used together. For example, mozzarella cheese which is commonly used when making pizza is most similar to other cheeses and pizza-related ingredients.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">most_similar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">u'mozzarella cheese'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'parmesan cheese'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.999547004699707</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'cheddar cheese'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9995082020759583</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'tomato'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9994533061981201</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'mushroom'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9994530081748962</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'cheese'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9994290471076965</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'mozzarella'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.999423086643219</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'sausage'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9993994832038879</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'pepperoni'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9993913173675537</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'onion'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9993910193443298</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'chicken breast'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.9993739724159241</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I chose to use the <strong>Continuous bag of words</strong> (CBOW) variant of Word2Vec. CBOW tries to learn a language model that tries to predict the center word in a sliding window. Due to the fact that Word2Vec tries to predict words based on the word's surroundings, it was vital to sort the ingredients alphabetically. If I did not sort the ingredients with respect to a consistent criterion, the model would interpret ingredients in a different order as having different contexts.</p><p>The hyperparameters chosen are below:</p><ul><li><p><code>size=100</code>, this refers to the dimensionality of the embeddings. I settled on 100 by trying 50, 100, 150 and seeing which performed best.</p></li><li><p><code>sg = 0</code>, this creates a CBOW model as opposed to a SkipGram model.</p></li><li><p><code>workers = 8</code>, the number of CPUs I have.</p></li><li><p><code>window = 6</code>, this is the size of the sliding window in which the center word is predicted. 6 was chosen as it is the average length of each document (ingredient list).</p></li><li><p><code>min_count = 1</code>, words below the min_count frequency are dropped before training occurs. 1 was chosen as I want all ingredients to have an embedding.</p></li></ul><p>The Word2Vec training code is below. I used the popular python library Gensim.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train_word2vec.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> gensim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Word2Vec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># get corpus with the documents sorted in alphabetical order</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_and_sort_corpus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    corpus_sorted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parsed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        corpus_sorted</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> corpus_sorted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># calculate average length of each document</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_window</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lengths </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> corpus</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    avg_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lengths</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lengths</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">round</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">avg_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> "__main__</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># load in data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'input/df_recipe.csv'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># parse the ingredients for each recipe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'parsed'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredient_parser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get corpus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    corpus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_and_sort_corpus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Length of corpus: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">corpus</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># train and save CBOW Word2Vec model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_cbow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Word2Vec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      corpus</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sg</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> workers</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> window</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">get_window</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> min_count</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vector_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'models/model_cbow.bin'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Word2Vec model successfully trained"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="document-embeddings">Document Embeddings<a class="hash-link" href="#document-embeddings" title="Direct link to heading">​</a></h2><p>In order to build the recipe recommendation, I needed to represent each document (each ingredient list) as a single embedding. This then allowed me to calculate corresponding similarities. So how can we use our word embeddings to compute a representative vector for the whole ingredient list? I tried out two different methods: one simple and one slightly more complicated. For this, I followed this excellent <a href="http://nadbordrozd.github.io/blog/2016/05/20/text-classification-with-word2vec/" target="_blank" rel="noopener noreferrer">tutorial</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="averaging-word-embeddings">Averaging Word Embeddings<a class="hash-link" href="#averaging-word-embeddings" title="Direct link to heading">​</a></h3><p>This does what it says on the tin, it directly averages all word embeddings in each document. The code is adapted from <a href="http://nadbordrozd.github.io/blog/2016/05/20/text-classification-with-word2vec/" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://towardsdatascience.com/nlp-performance-of-different-word-embeddings-on-text-classification-de648c6262b" target="_blank" rel="noopener noreferrer">here</a>.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/mean_word_embeddings.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MeanEmbeddingVectorizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_cbow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_cbow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_cbow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc_vector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doc_average_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> doc_word_vector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doc_average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index_to_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_vector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> mean</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> mean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doc_average_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vstack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doc_average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-tf-idf-to-aggregate-embeddings">Using TF-IDF to Aggregate Embeddings<a class="hash-link" href="#using-tf-idf-to-aggregate-embeddings" title="Direct link to heading">​</a></h3><p>Here we do the same as above but instead, we do a weighted mean and scale each vector using its inverse document frequency (IDF). The IDF measures the importance of a term across the whole corpus. IDF will weigh down terms that are very common across a corpus (in our case words like olive oil, garlic, butter, etc.) and weighs up rare terms. This is useful for us as it will give us better distinguishing power between recipes as the ingredients that are scaled-down will be ingredients that the user will tend to not give as an input to the recommendation system.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/tfidf_word_embeddings.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TfidfEmbeddingVectorizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model_cbow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_cbow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_cbow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">word_idf_weight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Build a tfidf model to compute each word's idf as its weight.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        text_docs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            text_docs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tfidf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TfidfVectorizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text_docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># if a word was never seen it is given idf of the max of known idf value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_idf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idf_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">word_idf_weight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> defaultdict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> max_idf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">idf_</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vocabulary_</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc_word_vector </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doc_average_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> doc_word_vector</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doc_average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Compute weighted mean of documents word embeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index_to_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_cbow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_vector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">word_idf_weight</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> mean</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> mean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">doc_average_list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vstack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doc_average</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="recommendation-system">Recommendation System<a class="hash-link" href="#recommendation-system" title="Direct link to heading">​</a></h2><p>This application simply consists of text data and there is no kind of ratings available, <strong>so we can not use matrix decomposition</strong> methods, such as SVD and correlation coefficient-based methods.
We use content-based filtering which enables us to recommend recipes to people based on the attributes (ingredients) the user provides. To measure the similarity between documents I used Cosine similarity. I also tried using Spacy and KNN but cosine similarity won in terms of performance (and ease).</p><p>Mathematically, <strong>cosine similarity</strong> measures the cosine of the angle between two vectors. For the mathematically inclined out there, this is the same as the inner product of the same vectors normalized to both have length 1. With cosine similarity, the smaller the angle, the higher the cosine similarity: so we are trying to maximize this score.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/recommendation_system.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> gensim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Word2Vec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">feature_extraction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TfidfVectorizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pairwise </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> cosine_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> collections </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> defaultdict</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ingredient_parser </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ingredient_parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_recommendations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">N</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Rank scores and output a pandas data frame containing all the details of the top N recipes.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param scores: list of cosine similarities</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># load in recipe dataset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_recipes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PARSED_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># order the scores with and filter to get the highest N scores</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">sorted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">N</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create dataframe to load in recommendations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recommendation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columns</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"recipe"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ingredients"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"score"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"url"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"recipe"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> title_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"recipe_name"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ingredients"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredient_parser_final</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"ingredients"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"url"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"recipe_urls"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"score"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">scores</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> recommendation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_recs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> N</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mean</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Get the top N recipe recomendations.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param ingredients: comma seperated string listing ingredients</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param N: number of recommendations</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    :param mean: False if using tfidf weighted embeddings, True if using simple mean</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># load in word2vec model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Word2Vec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"models/model_cbow.bin"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># normalize embeddings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init_sims</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">replace</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Successfully loaded model"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># load in data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"input/df_recipes.csv"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># parse ingredients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"parsed"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredient_parser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create corpus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    corpus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_and_sort_corpus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mean</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get average embdeddings for each document</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mean_vec_tr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MeanEmbeddingVectorizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc_vec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mean_vec_tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc_vec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> doc_vec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc_vec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># use TF-IDF as weights for each word embedding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tfidf_vec_tr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TfidfEmbeddingVectorizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tfidf_vec_tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc_vec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tfidf_vec_tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doc_vec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> doc_vec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc_vec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create embeddings for input text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create tokens with elements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">","</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># parse ingredient list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredient_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get embeddings for ingredient doc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mean</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_embedding </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mean_vec_tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_embedding </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tfidf_vec_tr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get cosine similarity between input embedding and all the document embeddings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cos_sim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cosine_similarity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_embedding</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> doc_vec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cos_sim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Filter top N recommendations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recommendations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_recommendations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">N</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> recommendations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">input</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"chicken thigh, onion, rice noodle, seaweed nori sheet, sesame, shallot, soy, spinach, star, tofu"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_recs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">input</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rec</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It’s worth noting that there was no concrete way of assessing the performance of the model so I had to evaluate the recommendations manually. To be honest, this ended up actually being quite fun… I also discovered a tonne of new recipes! It’s comforting to see that when we put in the ingredients (before they are parsed of course!) for our beloved Gennaro’s classic spaghetti carbonara we get the correct recommendation with a score of 1.</p><p>As of right now, a few items in my fridge/cupboards are: tomato sauce, pasta, zucchini, onion, cheese Our newly built recommendation system suggests we make:</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/test-b918c541a96847fd2391dab985ad0953.png" width="759" height="487" class="img_ev3q"></p><p>Sounds good to me — best get cooking! As we can see, all the ingredients in this recipe that I did not enter are all very common household items.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-an-app-using-streamlit">Creating an App Using Streamlit<a class="hash-link" href="#creating-an-app-using-streamlit" title="Direct link to heading">​</a></h2><p>Finally, I created and deployed an app using Streamlit. It was fantastically easy to make and the <a href="https://docs.streamlit.io/en/stable/api.html" target="_blank" rel="noopener noreferrer">documentation</a> was very easy to follow. Code for this app can be found on my <a href="https://github.com/jackmleitch/whatscooking-deployment" target="_blank" rel="noopener noreferrer">Github</a>.</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/app-b4b868e72b5712f9ec9ec9e0ee050eb6.png" width="1134" height="801" class="img_ev3q"></p><p>Thanks for reading and I hope you enjoyed it!</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="NLP" term="NLP"/>
        <category label="Recommendation System" term="Recommendation System"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Automating Mundane Web-Based Tasks With Selenium and Heroku]]></title>
        <id>Strava-AP</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Strava-AP"/>
        <updated>2021-07-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Automating away those unceasing repetitive tasks the easy way]]></summary>
        <content type="html"><![CDATA[<p><strong>Automating away those unceasing repetitive tasks the easy way</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-task-at-hand">The Task At Hand<a class="hash-link" href="#the-task-at-hand" title="Direct link to heading">​</a></h2><p>Being the avid runner and data lover that I am, naturally, I like to get the best out of logging my training. The solution I settled with a few years back was to log my training on both Strava, and Attackpoint. While both platforms provide a service for tracking exercise using GPS data, Strava has an emphasis on being a social network and it allows you to look into each activity in an in-depth way, something that Attackpoint lacks; Attackpoint on the other hand is more barebone and I personally prefer it for looking at my training as a whole (in timescales of weeks/months/years).</p><table><thead><tr><th><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/strava-a5edfbd05db0d12c5d82f3ac99e70f84.png" width="1302" height="1028" class="img_ev3q"></th><th><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/AP-e4d27653785b8355d2382a0ed2e0d559.png" width="1266" height="1106" class="img_ev3q"></th></tr></thead></table><p>The one problem I have, however, is that I always struggle to keep both of these logs up to date. Garmin (the maker of my running watch) syncs up with both websites, via an API, so my runs magically appear on both websites, so the problem isn't that my runs are only appearing on one website. The problem I have is that keeping both websites up to date with run notes/descriptions is a tedious affair. I tend to always keep Strava up to date and dip in and out of posting on Attackpoint whenever I can be bothered. So why not just automate away my commitment issues to these websites?</p><p><strong>The task: every time I run and write about it on Strava, take that description and add it to the corresponding run post on Attackpoint.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-game-plan">The Game Plan<a class="hash-link" href="#the-game-plan" title="Direct link to heading">​</a></h2><p>So I had a why, all that was left was to figure out how. Choosing to go from Strava to Attackpoint, and not the other way around, was an easy one. Firstly, Strava is way nicer to use, and secondly, the website is more modern, slick, and fancy so writing code to post and interact with it, although doable, would be more of a challenge. So how did I actually do this?</p><p>Enter Selenium. Selenium is a Python package that launches and controls a web browser. It is able to fill in forms and simulate mouse clicks in this browser. An excellent tutorial on Selenium, which I used a lot, can be found <a href="https://towardsdatascience.com/controlling-the-web-with-python-6fceb22c5f08" target="_blank" rel="noopener noreferrer">here</a>.</p><p>With these kinds of things, I find that it's always good to write down a plan of action; whether that be on paper or on your computer, it's totally down to personal preference, I tend to go paper. More often than not I end up deviating substantially from the initial plan when things inevitably go wrong but either way, I find writing down initial ideas/thoughts provides clarity and gives me a sense of direction.</p><p>So here is a rough outline of how I chose to automate this task:</p><ul><li>Make a call to the Strava API to get an ordered list of my recent run's unique IDs. This wasn't originally in the plan but obtaining my activities + the corresponding information in time order from Strava proved way harder than I initially thought due to added complications (for example, a lot of my runs group runs, and the html gets tricky here). Having these IDs made extracting the information was easier.</li></ul><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/strava_api.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_strava_run_ids</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id_num</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://www.strava.com/oauth/token"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activites_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"https://www.strava.com/api/v3/athlete/activities"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># my personal strava API information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">STRAVA_PAYLOAD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># check if there is a new request token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">auth_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verify</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    access_token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"access_token"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Authorization"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Bearer "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> access_token</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"per_page"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> id_num</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"page"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># make the request to the strava API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    my_dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activites_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">param</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># store list of recent (ordered) IDs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> activity </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> my_dataset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        id_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activity</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"id"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> id_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_strava_run_ids</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ids</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Use Selenium to log in to Strava, navigate to the ‘Your Activities’ tab, retrieve the information for runs corresponding to each unique activity ID. As you can see in the code below, Selenium couldn't be easier to use as it's so intuitive. The code below is a rough skeleton, the full code + comments can be found on my <a href="https://github.com/jackmleitch/strava2ap" target="_blank" rel="noopener noreferrer">Github</a> page.</li></ul><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/strava_selenium.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> selenium </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> webdriver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> webdriver_manager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">chrome </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ChromeDriverManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> utils </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> remove_emoji</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> stravaAPI </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> get_strava_run_ids</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch_strava_activities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_of_activities</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># website login details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strava_login </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">STRAVA_LOGIN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># use Chrome to access web (will update chrome driver if needed)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> webdriver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Chrome</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ChromeDriverManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">install</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># open the website</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"https://www.strava.com/login"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># add username and password and login</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name_box </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"email"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name_box</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send_keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strava_login</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"email"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pass_box </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"password"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pass_box</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send_keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strava_login</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"password"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    login_button </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"login-button"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># filter the feed to only my activities</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    following_button </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"feed-filter-btn"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    your_activities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"//a[@href='/dashboard?feed_type=my_activity']"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># use strava API to get ids for latest runs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_strava_run_ids</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_of_activities</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get i latest runs and run details</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strava_activities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">id</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ids</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># group runs and non-group runs have different css classes so we need to treat separately</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string-interpolation string" style="color:#e3116c">f'//div[@id="Activity-</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">" and @class="activity feed-entry card"]'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            entry_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_class_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"entry-body"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token string-interpolation string" style="color:#e3116c">f'//li[@id="Activity-</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">" and @class="activity child-entry"]'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                entry_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'//div[@class="entry-body entry-inset"]'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"No activity with id = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> found"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get run title</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry_body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_css_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># some runs have no description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entry_body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_css_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry_body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_css_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># remove emojis from title and description as attackpoint cant deal with them</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> remove_emoji</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">title</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> remove_emoji</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">description</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get run distance, pace, and time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        distance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry_body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_css_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"b"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pace </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry_body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_css_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"b"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> entry_body</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_css_selector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"b"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># store results in a dictionary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> title</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           strava_activities</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string-interpolation string" style="color:#e3116c">f"activity_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">"title"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> title</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">"description"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> description</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">"distance"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> distance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">"time"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">"pace"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># quit driver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> strava_activities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># check</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fetch_strava_activities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activities</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Now we have all my most recent activities (in order of completion!) along with the activities details: time, title, description, distance, and pace. All that is left to do now is add the title and descriptions to my Attackpoint page, although there are a few minor subtleties. First of all, if any activities have descriptions already I want to leave them alone. Secondly, if any of the Strava titles are the default i.e. haven't been changed, I also want to leave the post alone as I haven't gotten around to name the Strava run yet. As with before, some code details have been left out for clarity.</li></ul><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/attackpoint_selenium.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> selenium </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> webdriver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> webdriver_manager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">chrome </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ChromeDriverManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> utils </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> format_time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> get_pace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> get_dates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> stravaSelenium </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> fetch_strava_activities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">attackpoint_login</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># similar to strava login</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fetch_attackpoint_activities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ap_activities</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">update_description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fetch recent activities from strava</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strava </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fetch_strava_activities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_of_activities</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">days </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fetch recent activities from attackpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attackpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fetch_attackpoint_activities</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">days</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># get a list of activity descriptions to post on attackpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    descriptions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strava</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attackpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get activity titles and descriptions from the strava data collected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        activity_title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> strava</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string-interpolation string" style="color:#e3116c">f"activity_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"title"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        activity_description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> strava</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string-interpolation string" style="color:#e3116c">f"activity_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"description"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        descriptions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">activity_post</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># counters to keep track of things</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counter_activities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activities_edited </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># if these titles are on strava then dont update activity description on ap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strava_default_titles </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Morning Run"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># loop through days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> day </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> get_dates</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">days</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># go onto the days activity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            check_activity_date </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string-interpolation string" style="color:#e3116c">f'//a[@href="/viewlog.jsp/user_13190/period-1/enddate-</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">day</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"]'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        edit_button </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'//*[@title="Edit this entry"]'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># loop over each activity on given day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">edit_button</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            edit_button </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_elements_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'//*[@title="Edit this entry"]'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># reverse edit_button to get activities in order</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            edit_button </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> edit_button</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            edit_button</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            distance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"distance"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_attribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"value"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># if not a run then ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> distance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                counter_activities </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                description </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_class_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">"logtextarea"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_attribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"value"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># if no description then ignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># if there is no description then we can add one!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> description</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    strava_title </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> strava</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string-interpolation string" style="color:#e3116c">f"activity_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">counter_activities</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"title"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic"># if title is not on default strava titles</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> strava_title </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> strava_default_titles</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        activities_edited </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        text_input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_class_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"logtextarea"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        text_input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send_keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">descriptions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">counter_activities</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        submit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_element_by_xpath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">"//input[@value='Submit']"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"https://www.attackpoint.org/log.jsp/user_13190"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"\n</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">activities_edited</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> activity descriptions posted"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    update_description</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And we are done, if I run <code>attackpointSelenium.py</code> in the terminal it will add any missing descriptions to my Attackpoint!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="making-the-automatic-fully-automatic">Making The Automatic Fully Automatic<a class="hash-link" href="#making-the-automatic-fully-automatic" title="Direct link to heading">​</a></h2><p>Obviously running a line of code once or twice a day is WAY too much effort so the last thing that was left to do was deploy the code online somewhere so that I was completely out of the loop. Following this excellent <a href="https://medium.com/analytics-vidhya/schedule-a-python-script-on-heroku-a978b2f91ca8" target="_blank" rel="noopener noreferrer">tutorial</a> I was able to deploy my code to <a href="https://id.heroku.com/login" target="_blank" rel="noopener noreferrer">Heroku</a> and schedule it so that my code checks to see if my Attackpoint needs updating every 10 minutes! And best of all, it's completely free.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>TL;DR wrote code to automatically post information from one website onto the corresponding section of another.</p></div></div><p>Code: <a href="https://github.com/jackmleitch/strava2ap" target="_blank" rel="noopener noreferrer">https://github.com/jackmleitch/strava2ap</a></p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="Automation" term="Automation"/>
        <category label="Web Scraping" term="Web Scraping"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Automating the Setup of my Data Science Projects]]></title>
        <id>Project-Auto</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Project-Auto"/>
        <updated>2020-12-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Using Python to automate the process of setting up new project directories and making the first commit to a new repository in Github]]></summary>
        <content type="html"><![CDATA[<p><strong>Using Python to automate the process of setting up new project directories and making the first commit to a new repository in Github</strong></p><p>I find myself doing the same thing over and over again when starting a new data science project. As well as it being extremely tedious (and frustrating when I can’t remember how to use git…), it's also just a waste of time. Inspired by the YouTuber <a href="https://www.youtube.com/channel/UCWr0mx597DnSGLFk1WfvSkQ" target="_blank" rel="noopener noreferrer">Kalle Hallden</a>, I decided to try and automate this process using Python.</p><p>As discussed in one of my previous blog posts, <a href="https://towardsdatascience.com/organizing-machine-learning-projects-e4f86f9fdd9c" target="_blank" rel="noopener noreferrer">Organizing machine learning projects</a>, whenever I start a new project I like to use the same file system. Putting everything into folders named src, input, models, notebooks, and notes make it super easy to find the files I'm looking for lending itself nicely to code reproducibility. An example file structure looks like this:</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/folder-e77a5ce21bf5a21c9097363edb66c1d9.png" width="1118" height="568" class="img_ev3q"></p><p>The first thing I did was make a checklist of what I wanted my custom bash function to do:</p><ul><li><p>Create a folder with the project name inside my Projects folder</p></li><li><p>Create folders inside this folder named: <code>src</code>, <code>input</code>, <code>models</code>, <code>notebooks</code>, <code>notes</code></p></li><li><p>Use Github API to create a new repository with the project name</p></li><li><p>Add a <code>README.md</code>, a <code>.gitignore</code>, and a <code>notes.txt</code></p></li><li><p>Do the standard git stuff — <code>init</code>, <code>add</code>, <code>commit</code>, <code>remote</code>, and <code>push</code></p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-build">The Build<a class="hash-link" href="#the-build" title="Direct link to heading">​</a></h2><p>This turned out to be a relatively simple build and the only packages that I need to install were <strong>PyGithub</strong> to use the Github API, and <strong>python-dotenv</strong> to make use of environment variables.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pip install PyGithub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install python</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dotenv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Inside a <code>.env</code> file, I added the hardcoded stuff and my personal Github information. We can access our Github account using the API with our username and password but instead, I generated a personal token <a href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer">here</a>. This is more secure and was actually easier to do.</p><p>I then wrote a function <code>create.py</code> which creates the file system described above with the main directory being the project title. It also uses the Github API to create a repository on Github with the project name.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/create.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> dotenv </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> load_dotenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> github </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Github</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load_dotenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Get data from a .env file thats in .gitignore</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"FILEPATH"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Access to token generated from github</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"TOKEN"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subFolders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'input'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'src'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'models'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'notebooks'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'notes'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Extract project name from the command line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    folderName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Make directory in my files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">makedirs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">folderName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Adds in sub-directories of src, input, ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">subFolders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        subPath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">folderName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">subFolders</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">makedirs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">subPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Uses Githubs API to create repository</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Github</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_user</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_repo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">folderName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Succesfully created repository </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">folderName</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>sys.argv</code> is the list of command-line arguments passed to the Python program. So <code>sys.argv[1]</code> gives us the project name if we, for example, write <code>python create.py ProjectName</code> in the terminal.</p><p>I then use my personal Github token (stored in .env) to access my Github account and create a new repository named ProjectName (or whatever you write after you call <code>create.py</code>).</p><p>The next step was to write a shell script to call this function and then initialize the git repository.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/.create.sh</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># . means to source the contents of this file into the current shell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function create() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd '/Users/Jack/Documents/Projects/project_auto/'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # $1 is the first positional argument in the script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    python create.py $1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Add notes.txt file to notes folder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd $FILEPATH$1/notes/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo Notes &gt; notes.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # The standard git stuff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cd $FILEPATH$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo 'notes/' &gt;&gt; .gitignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo '__pycache__/' &gt;&gt; .gitignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    touch README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git init -b main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git add .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git commit -m "Project creation"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git remote add origin https://github.com/$USERNAME/$1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git push -u origin main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This <strong>create</strong> function is the end product. It first sets the directory to the home of this project and calls the <code>create.py</code> function — the $1 here refers to the first argument after the terminal function. For example, if we run <code>create MNIST</code> in the terminal, this function will subsequently run <code>create.py MNIST</code> and create a project titled MNIST.</p><p>A <code>notes.txt</code> file is then added to the notes folder, this is then added, along with the pycache, to the <code>.gitignore</code> file. After this, a <code>README.md</code> is created and the whole directory is then committed to our newly created repository. Finally, the remote is added to the directory and it is all pushed to Github.</p><p>The last piece of the puzzle was to add this <code>.create.sh</code> script to the <code>bash_profile</code>, this is the initialization file for configuring the user environment. To put it simply, the create function will now be loaded into the terminals ‘library’. So whenever I now load up my terminal, I can easily just call on the create function. On macOS we can do this by:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nano .bash_profile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This then opens up the <code>bash_profile</code>. We can then add the following line of code to the profile.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">source /PATH_TO_THE_FILE/.create.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Lastly, to update the new changes we just run the same line again in the terminal.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-everything-out">Testing Everything Out<a class="hash-link" href="#testing-everything-out" title="Direct link to heading">​</a></h2><p>Let’s test our new found automatic abilities out! We can run the following in the terminal:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">create PneumothoraxSegmentation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In our projects folder, we can now see a new file!</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/files-9142a279f53ecc941e25cb9801c3b525.png" width="1100" height="346" class="img_ev3q"></p><p>And on my Github page, I now have a new repository!</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/github-7f8ed530b2393db3e15e498ddaec2ec2.png" width="1400" height="623" class="img_ev3q"></p><p>Job done. This was a nice quick and easy automation that is going to make my life (and hopefully yours) a lot easier. With two simple scripts, we were able to fully automate the mundane tasks involved in creating a new data science project. I hope this post inspires you to start automating more of your data science workflow!</p><p>Thanks for reading and I hope you enjoyed it.</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="Automation" term="Automation"/>
        <category label="Github" term="Github"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Building a Recipe Recommendation API using Scikit-Learn, NLTK, Docker, Flask, and Heroku]]></title>
        <id>Recipe-Recommendation2</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Recipe-Recommendation2"/>
        <updated>2020-12-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The journey to my first ‘full-stack’ data science project (part 2) — building and deployment]]></summary>
        <content type="html"><![CDATA[<p><strong>The journey to my first ‘full-stack’ data science project (part 2) — building and deployment</strong></p><p>So… the idea: Given a list of ingredients, what are different recipes I can make? That is, what recipes can I make with the food I have in my apartment?</p><p>First things first, if you would like to see my API in action (or use it!) then please do so by following (I have updated the app and release a new blog on it soon):</p><p><a href="https://share.streamlit.io/jackmleitch/whatscooking-deployment/streamlit.py" target="_blank" rel="noopener noreferrer">https://share.streamlit.io/jackmleitch/whatscooking-deployment/streamlit.py</a></p><p>In my first blog post on this project, I walked through how I scraped the data for this project. The data being cooking recipes and the corresponding ingredients. Since then I have added more recipes so we now have a total of 4647. Please feel free to make use of this dataset yourself, you can find it on my <a href="https://github.com/jackmleitch/Whatscooking-" target="_blank" rel="noopener noreferrer">Github</a>.</p><p>This post will be focused on preprocessing the data, building the recommendation system, and then finally deploying the model using Flask and Heroku.</p><p>The process to build the recommendation system is as follows:
<img loading="lazy" alt="flowchart" src="/PersonalWebsite/assets/images/flowchart-55db802e3605933d0b683dc6d533f488.png" width="1347" height="925" class="img_ev3q"></p><p>We start by cleaning and parsing the dataset, then we extract the numerical features from the data, from here we can apply a similarity function to find the similarity between <strong>ingredients for known recipes</strong> and the <strong>ingredients given by the end-user</strong>. Finally, we can get the top-recommended recipes according to the similarity score.</p><p>Unlike the first article in this series, this will not be a tutorial of the tools I used, but it will describe how I built the system and why I made the decisions I did along the way. Although, the code comments do a good job of explaining things in my opinion — so check them out if you’re curious. As with most projects, my aim was to create the simplest model I could to get the job done to the standard I desired.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preprocessing-and-parsing-of-ingredients">Preprocessing and Parsing of Ingredients<a class="hash-link" href="#preprocessing-and-parsing-of-ingredients" title="Direct link to heading">​</a></h2><p>To understand the task at hand here, let's look at an example. The delicious ‘Gennaro’s classic spaghetti carbonara’ recipe found on Jamie Oliver’s <a href="https://www.jamieoliver.com/recipes/pasta-recipes/gennaro-s-classic-spaghetti-carbonara/" target="_blank" rel="noopener noreferrer">website</a> requires the ingredients:</p><ul><li><p>3 large free-range egg yolks</p></li><li><p>40 g Parmesan cheese, plus extra to serve</p></li><li><p>1 x 150 g piece of higher-welfare pancetta</p></li><li><p>200 g dried spaghetti</p></li><li><p>1 clove of garlic</p></li><li><p>extra virgin olive oil</p></li></ul><p>There is a lot of redundant information here; for example, weights and measures are not going to add value to the vector encodings of the recipe. If anything, it is going to make distinguishing between recipes more difficult. So we need to get rid of those. A quick google search led me to a <a href="https://en.wikibooks.org/wiki/Cookbook:Units_of_measurement" target="_blank" rel="noopener noreferrer">Wikipedia page</a> containing a list of standard cooking metrics e.g. clove, gram (g), teaspoon, etc. Removing all these words in my ingredient parser worked really well.</p><p>We also want to remove stop words from our ingredients. In NLP ‘stop words’ refer to the most common words in a language. For example, the sentence ‘learning about what stop words are’, becomes, ‘learning stop words’. NLTK provides us with an easy way to remove (most of) these words.</p><p>There are also other words in the ingredients that are useless to us — these are the words that are very common among recipes. Oil, for example, is used in most recipes and will provide little to no distinguishing power between recipes. Also, most people have oil in their homes so having to write oil every time you use the API is cumbersome and pointless. There are advanced NLP techniques, for example using <a href="https://open.blogs.nytimes.com/2015/04/09/extracting-structured-data-from-recipes-using-conditional-random-fields/" target="_blank" rel="noopener noreferrer">conditional random fields</a> (a class of statistical modeling), that can calculate the probability that a word is an ingredient, as opposed to a measure, texture, or another type of word that surrounds the ingredient word. But, simply removing the most common words seemed to be very effective, so I did this. Occam’s razor and all that jazz… To get the most common words we can do the following:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> nltk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vocabulary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nltk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FreqDist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This was done once I had already preprocessed the ingredients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> ingredients </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredients</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vocabulary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> frequency </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> vocabulary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">most_common</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f'</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">word</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">frequency</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">'</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have one final obstacle to get over, however. When we try to remove these ‘junk’ words from our ingredient list, what happens when we have different variations of the same word? What happens if we want to remove every occurrence of the word ‘pound’ but the recipe ingredients say ‘pounds’? Luckily there is a pretty trivial workaround: lemmatization and stemming. Stemming and lemmatization both generate the root form of inflected words — the difference is that a stem might not be an actual word whereas, a lemma is an actual language word. Although lemmatization is often slower, I chose to use this technique as I know the ingredients will be actual words which is useful for debugging and visualization (the results turned out to be practically identical using stemming instead). When the user feeds ingredients to the API we also lemmatize those words as the lemmatized words are the words with the embeddings.</p><p>We can put this all together in a function, <code>ingredient_parser</code>, along with some other standard preprocessing: getting rid of punctuation, removing accents, making everything lowercase, getting rid of Unicode.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/parse_ingredients.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ingredient_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># measures and common words (already lemmatized)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    measures </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'teaspoon'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'t'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'tsp.'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'tablespoon'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'T'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    words_to_remove </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'fresh'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'oil'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'a'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'red'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'bunch'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Turn ingredient list from string into a list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">literal_eval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># We first get rid of all the punctuation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    translator </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maketrans</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">''</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">punctuation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialize nltk's lemmatizer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lemmatizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> WordNetLemmatizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingred_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> ingredients</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">translate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">translator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># We split up with hyphens as well as spaces</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">' |-'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get rid of words containing non alphabet letters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isalpha</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Turn everything to lowercase</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># remove accents</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">unidecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unidecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Lemmatize words so we can compare words to measuring words</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">lemmatizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lemmatize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># get rid of stop words</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stop_words </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">corpus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stopwords</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">words</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'english'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> stop_words</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Gets rid of measuring words/phrases, e.g. heaped teaspoon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> measures</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Get rid of common easy words</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">word </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> items </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> word </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> words_to_remove</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ingred_list</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">' '</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ingred_list </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">' '</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingred_list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ingred_list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When parsing the ingredients for ‘Gennaro’s classic spaghetti carbonara’ we get: egg yolk parmesan cheese pancetta spaghetti garlic. Perfect, that works fantastically!</p><p>Using lambda functions, it’s easy to parse all of the ingredients.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">recipe_df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RECIPES_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients_parsed'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ingredient_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recipe_df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropna</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PARSED_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="extracting-features">Extracting Features<a class="hash-link" href="#extracting-features" title="Direct link to heading">​</a></h2><p>We now need to encode each document (recipe ingredients), and as before, simple models worked really well. One of the most basic models that should always be tried when doing NLP is <strong>bag of words</strong>. This entails creating a huge sparse matrix that stores counts of all the words in our corpus (all of the documents i.e. all of the ingredients for every recipe). Scikit-learn’s CountVectorizer has a nice implementation for this.</p><p>Bag of words performed ok but <strong>TF-IDF</strong> (term frequencies-inverse document frequency) marginally out-performed it, so we opted for this instead. I’m not going to go into the details of how tf-idf works as it is not relevant to the blog but it basically does what it says on the tin. As per usual, Scikit-learn has a lovely implementation of this: TfidfVectorizer. I then saved the model and encodings using pickle, as retraining the model every time the API is used would make it painfully slow.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/feature_extraction.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">feature_extraction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TfidfVectorizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pickle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># load in parsed recipe dataset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df_recipes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PARSED_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Tfidf needs unicode or string types</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients_parsed'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain">       df_recipes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingredients_parsed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'U'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># TF-IDF feature extractor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tfidf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TfidfVectorizer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients_parsed'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tfidf_recipe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients_parsed'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># save the tfidf model and encodings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TFIDF_MODEL_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wb"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     pickle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tfidf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TFIDF_ENCODING_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"wb"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     pickle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tfidf_recipe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="recommendation-system">Recommendation System<a class="hash-link" href="#recommendation-system" title="Direct link to heading">​</a></h2><p>This application simply consists of text data and there is no kind of ratings available, <strong>so we can not use</strong> matrix decomposition methods, such as SVD and correlation coefficient-based methods.</p><p>We use content-based filtering which enables us to recommend recipes to people based on the attributes (ingredients) the user provides. To measure the similarity between documents I used <strong>Cosine similarity</strong>. I also tried using Spacy and KNN but cosine similarity won in terms of performance (and ease).</p><p>Mathematically, cosine similarity measures the cosine of the angle between two vectors. For the mathematically inclined out there, this is the same as the inner product of the same vectors normalized to both have length 1. I chose to use this measure of similarity as even if the two similar documents are far apart by the Euclidean distance (due to the size of the document), chances are they may still be oriented closer together. For example, if the user inputs a lot of ingredients and only the first half match with a recipe, we should, in theory, still get a good recipe match. In cosine similarity, the smaller the angle, the higher the cosine similarity: so we are trying to maximize this score.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pairwise </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> cosine_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">feature_extraction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TfidfVectorizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pickle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ingredient_parser </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ingredient_parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># load in tdidf model and encodings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TFIDF_ENCODING_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'rb'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     tfidf_encodings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pickle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TFIDF_MODEL_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"rb"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     tfidf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pickle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># parse the ingredients using my ingredient_parser</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingredients_parsed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredient_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingredients_parsed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredient_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># use our pretrained tfidf model to encode our input ingredients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingredients_tfidf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tfidf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ingredients_parsed</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># calculate cosine similarity between actual recipe ingreds and test ingreds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cos_sim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cosine_similarity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients_tfidf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tfidf_encodings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cos_sim</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I then wrote a function, <code>get_recommendations</code>, to rank these scores and output a pandas data frame containing all the details of the top <strong>N</strong> recipes.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/recommendation_system.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_recommendations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">N</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># load in recipe dataset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_recipes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PARSED_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># order the scores with and filter to get the highest N scores</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    top </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">sorted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">N</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create dataframe to load in recommendations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recommendation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columns </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'recipe'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'score'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'url'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> top</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'recipe'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> title_parser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'recipe_name'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ingredient_parser_final</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'url'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_recipes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'recipe_urls'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        recommendation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">at</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'score'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"{:.3f}"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> recommendation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It’s worth noting that there was no concrete way of assessing the performance of the model so I had to evaluate the recommendations manually. To be honest though, this ended up actually being quite fun… I also discovered a tonne of new recipes! It’s comforting to see that when we put in the ingredients (before they are parsed of course!) for our beloved Gennaro’s classic spaghetti carbonara we get the correct recommendation with a score of 1.</p><p>As of right now, a few items in my fridge/cupboards are: ground beef, pasta, spaghetti, tomato pasta sauce, bacon, onion, zucchini, and, cheese. Our newly built recommendation system suggests we make:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"ingredients"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"1 (15 ounce) can tomato sauce, 1 (8 ounce) package uncooked pasta shells, 1 large zucchini - peeled and cubed, 1 teaspoon dried basil, 1 teaspoon dried oregano, 1/2 cup white sugar, 1/2 medium onion, finely chopped, 1/4 cup grated Romano cheese, 1/4 cup olive oil, 1/8 teaspoon crushed red pepper flakes, 2 cups water, 3 cloves garlic, minced"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"recipe"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Zucchini and Shells"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"score: "</span><span class="token number" style="color:#36acaa">0.760</span><span class="token plain">"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"url"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"https://www.allrecipes.com/recipe/88377/zucchini-and-shells/"</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Sounds good to me — best get cooking!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="create-an-api-to-deploy-the-model">Create an API to Deploy the Model<a class="hash-link" href="#create-an-api-to-deploy-the-model" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-using-flask">Deployment using Flask<a class="hash-link" href="#deployment-using-flask" title="Direct link to heading">​</a></h3><p>So how can I serve this model I have built to an end-user? I created an API that can be used to input ingredients and in turn, it outputs the top 5 recipe recommendations based on those ingredients. To build this API I used Flask, which is a micro web service framework.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/app.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jsonify</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pickle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">feature_extraction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TfidfVectorizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pairwise </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> cosine_similarity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ingredient_parser </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ingredient_parser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rec_sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"GET"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># This is the homepage of our API.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># It can be accessed by http://127.0.0.1:5000/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> HELLO_HTML</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HELLO_HTML </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">"""</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">     &lt;html&gt;&lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">         &lt;h1&gt;Welcome to my api: Whatscooking!&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">         &lt;p&gt;Please add some ingredients to the url to receive recipe recommendations.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            You can do this by appending "/recipe?ingredients= Pasta Tomato ..." to the current url.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">         &lt;br&gt;Click &lt;a href="/recipe?ingredients= pasta tomato onion"&gt;here&lt;/a&gt; for an example when using the ingredients: pasta, tomato and onion.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">     &lt;/body&gt;&lt;/html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">     """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">route</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'/recipe'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methods</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"GET"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">recommend_recipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># This is our endpoint. It can be accessed by http://127.0.0.1:5000/recipe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recipe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rec_sys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RecSys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># We need to turn output into JSON.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> row </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> recipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterrows</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">'recipe'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'recipe'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">'score'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'score'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'ingredients'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token string" style="color:#e3116c">'url'</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'url'</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> jsonify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"0.0.0.0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> debug</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can start this API by running the command <code>python src/app.py</code> and the API will start on localhost on port 5000. We can access recipe recommendations for the inputs pasta, tomato, and onion by visiting <a href="http://192.168.1.51:5000/recipe?ingredients=%20pasta%20tomato%20onion" target="_blank" rel="noopener noreferrer">http://192.168.1.51:5000/recipe?ingredients=%20pasta%20tomato%20onion</a> in our browser.</p><p><img loading="lazy" alt="api_call" src="/PersonalWebsite/assets/images/api_call-dc8bd3528db12682f8b17ad04df9c60e.png" width="1400" height="306" class="img_ev3q">
<img loading="lazy" alt="api_response" src="/PersonalWebsite/assets/images/api_response-30122221120391d52a884f4f2bcb61a4.png" width="1400" height="659" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-flask-api-to-heroku--its-time-to-go-online">Deploying Flask API to Heroku — It’s Time To Go Online<a class="hash-link" href="#deploying-flask-api-to-heroku--its-time-to-go-online" title="Direct link to heading">​</a></h3><p>Deploying a Flask API to Heroku is extremely easy if you use Github! First, I created a file in my project folder called Procfile, with no extension. All you need to put inside this file is:</p><p><code>web: gunicorn app:app</code></p><p>The next step was to create a file called <code>requirements.txt</code> which consists of all of the python libraries that I used for this project. If you’re working in a virtual environment (I use conda) then it’s as easy as <code>pip freeze &gt; requirements.txt</code> — make sure you're in the correct working directory otherwise it’ll save the file somewhere else.</p><p>All I had to do now was commit the changes to <a href="https://github.com/jackmleitch/whatscooking-deployment" target="_blank" rel="noopener noreferrer">my Github repository</a> and follow the deployment steps on <a href="https://dashboard.heroku.com/apps" target="_blank" rel="noopener noreferrer">https://dashboard.heroku.com/apps</a>. If you would like to try out or use my API, please do by visiting:</p><ul><li><p><a href="https://whats-cooking-recommendation.herokuapp.com/-" target="_blank" rel="noopener noreferrer">https://whats-cooking-recommendation.herokuapp.com/-</a> if you are in USA</p></li><li><p><a href="https://whatscooking-deployment.herokuapp.com/-" target="_blank" rel="noopener noreferrer">https://whatscooking-deployment.herokuapp.com/-</a> if you are in Europe</p></li><li><p>Either should work if you are elsewhere, it’ll just be a tad slower</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker">Docker<a class="hash-link" href="#docker" title="Direct link to heading">​</a></h3><p>We have now reached the stage where I am happy with the model I have built, so I want to be able to distribute my model to others so that they can use it too. I have uploaded my whole project to <a href="https://github.com/jackmleitch/Whatscooking-" target="_blank" rel="noopener noreferrer">Github</a> but that's not quite enough. Just because the code works on my computer does not mean it's going to work on someone else's computer, this could be because of many reasons. It would be fantastic if when I distribute my code, I replicate my computer so that I know it is going to work. One of the most popular ways of doing this nowadays is by using <a href="https://github.com/jackmleitch/Whatscooking-" target="_blank" rel="noopener noreferrer">Docker Containers</a>.</p><p>The first thing I did was create a <strong>docker file</strong> called Dockerfile (it doesn't have an extension). Simply put, the docker file tells us how to build our environment and contains all the commands a user could call in the command line to assemble the image.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Dockerfile</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Include where we get the image from (operating system)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">18.04</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAINTAINER Jack Leitch </span><span class="token string" style="color:#e3116c">'jackmleitch@gmail.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We cannot press Y so we do it automatically.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apt</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">get update </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> apt</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">get install </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">y \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    git \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    curl \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ca</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">certificates \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    python3 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    python3</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">pip \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">rf </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">var</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">apt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lists</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set working directory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Copy everything in currect directory into the app directory.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADD </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Install all of the requirements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN pip3 install </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">r requirements</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Download wordnet as its used to lemmatize</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN python3 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">"import nltk; nltk.download('wordnet')"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># CMD executes once the container is started</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CMD </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"python3"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"app.py"</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once I created the docker file, I then needed to build my container — and that's very easy. Side note: if you do this, make sure all your file paths (I keep mine in a <code>config.py</code> file) aren’t specific to your computer because docker is like a virtual machine and contains its own file system e.g. you can put <code>./input/df_recipes.csv</code> instead.</p><p><code>docker build -f Dockerfile -t whatscooking:api</code></p><p>To start our API, on any machine (!), all we have to do now is (assuming you have downloaded the docker container):</p><p><code>docker run -p 5000:5000 -d whatscooking:api</code></p><p>If you want to check out the container yourself, here is a link to my <a href="https://hub.docker.com/repository/docker/jackmleitch/whatscooking" target="_blank" rel="noopener noreferrer">Docker Hub</a>. You can pull the image by:</p><p><code>docker pull jackmleitch/whatscooking:api</code></p><p>The plan moving forward from here is to build a nicer interface to the API using Streamlit.</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="NLP" term="NLP"/>
        <category label="Recommendation System" term="Recommendation System"/>
        <category label="API" term="API"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Organizing Machine Learning Projects]]></title>
        <id>OrganizingML</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/OrganizingML"/>
        <updated>2020-11-17T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[A guide to organizing your machine learning projects]]></summary>
        <content type="html"><![CDATA[<p><strong>A guide to organizing your machine learning projects</strong></p><p>I just want to start with a brief disclaimer. This is how I personally organize my projects and it’s what works for me, that doesn't necessarily mean it will work for you. However, there is definitely something to be said about how good organization streamlines your workflow. Building my ML framework the way I do allows me to work in a very plug n’ play way: I can train, change, adjust my models without making too many changes to my code.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-is-it-important-to-organize-a-project">Why is it important to organize a project?<a class="hash-link" href="#why-is-it-important-to-organize-a-project" title="Direct link to heading">​</a></h2><ol><li><p>Productivity. If you have a well-organized project, with everything in the same directory, you don't waste time searching for files, datasets, codes, models, etc.</p></li><li><p>Reproducibility. You’ll find that a lot of your data science projects have at least some repetitively to them. For example, with the proper organization, you could easily go back and find/use the same script to split your data into folds.</p></li><li><p>Understandability. A well-organized project can easily be understood by other data scientists when shared on Github.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-structure">File structure<a class="hash-link" href="#file-structure" title="Direct link to heading">​</a></h2><p>The first thing I do whenever I start a new project is to make a folder and name it something appropriate, for example, “MNIST” or “digit_recognition”. Inside the main project folder, I always create the same subfolders: <strong>notes</strong>, <strong>input</strong>, <strong>src</strong>, <strong>models</strong>, <strong>notebooks</strong>. Don’t forget to add a <code>README.md</code> file as well! As intuitive as this breakdown seems, it makes one hell of a difference in productivity.</p><p>What do I put in each folder?</p><ul><li><p><code>notes</code>: I add any notes to this folder, this can be anything! URLs to useful webpages, chapters/pages of books, descriptions of variables, a rough outline of the task at hand, etc.</p></li><li><p><code>input</code>: This folder contains all of the input files and data for the machine learning project. For example, it may contain CSV files, text embedding, or images (in another subfolder though), to list a few things.</p></li><li><p><code>src</code>: Any <code>.py</code> file is kept in this folder. Simple.</p></li><li><p><code>models</code>: We keep all of our trained models in here (the useful ones…).</p></li><li><p><code>notebooks</code>: We can store our Jupyter notebooks here (any <code>.ipynb</code> file). Note that I tend to only use notebooks for data exploration and plotting.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-basic-project-example">A (basic) project example<a class="hash-link" href="#a-basic-project-example" title="Direct link to heading">​</a></h2><p>When I build my projects I like to automate as much as possible. That is, I try to repeat myself as little as possible and I like to change things like models and hyperparameters with as little code as I can. Let's look to build a very simple model to classify the MNIST dataset. For those of you that have been living under a rock, this dataset is the de facto “hello world” of computer vision. The data files <code>train.csv</code> and <code>test.csv</code> contain gray-scale images of hand-drawn digits, from zero through nine. Given the pixel intensity values (each column represents a pixel) of an image, we aim to identify which digit the image is. This is a supervised problem. Please note that the models I am creating are by no means the best for classifying this dataset, that isn't the point of this blog post.</p><p>So, how do we start? Well, as with most things data science, we first need to decide on a metric. By looking at a count plot (<code>sns.countplot()</code> (this was done in a Jupyter notebook in the notebooks folder!)) we can see that the distribution of labels is fairly uniform, so plain and simple accuracy should do the trick!</p><p>The next thing we need to do is create some cross-validation folds. The first script I added to my src folder was to do exactly this. <code>create_folds.py</code> reads <code>mnist_train.csv</code> from the input folder and creates a new file <code>mnist_train_folds.csv</code> (saved to the input folder) which has a new column, kfolds, containing fold numbers. As with most classification problems, I used stratified k-folds. To see the script, please check out my <a href="https://github.com/jackmleitch/Almost-any-ML-problem/tree/master/MNIST" target="_blank" rel="noopener noreferrer">Github page</a>.</p><p>Now that we have decided on a metric and created folds, we can start making some basic models. With the aim of this post in mind, I decided to completely skip any kind of preprocessing (sorry!). What we are going to do is create a general python script to train our model(s), <code>train.py</code>, and then we will make some changes so that we hardcode as little as possible. The aim here is to be able to change a lot of things without changing much (if any) code. So, let's get cracking!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> joblib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> metrics</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we first read in data with our folds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"../input/mnist_train_folds.csv"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we then split it into our training and validation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># drop target column (label) and turn to np array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">drop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'label'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># same for validation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">drop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'label'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialize simple decision tree classifier and fit data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tree</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DecisionTreeClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create predictions for validation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># calculate and print accuracy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accuracy_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Fold=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Accuracy=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">score</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># save the model (not very necessary for a smaller model though)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    joblib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"../models/dt_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.bin"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then run this script by calling <code>python src/train.py</code> in the terminal. This script will read our data, train a decision tree classifier, score our predictions, and save the model for each fold. Note that you will need to set the working directory. For example:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; cd "/Users/Jack/Documents/MNIST/src"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; python train.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fold=0, Accuracy=0.858</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fold=1, Accuracy=0.860</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fold=2, Accuracy=0.859</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can do a lot better than this... We have hardcoded the fold numbers, the training file, the output folder, the model, and the hyperparameters. We can change all of this.</p><p>The first easy thing we can do is create a <code>config.py</code> file with all of the training files and output folder.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/config.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TRAINING_FILE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"../input/mnist_train_folds.csv"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OUTPUT_PATH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"../models/"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Changing the script to incorporate this is easy! The changes are in bold.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> joblib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> metrics</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we first read in data with our folds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TRAINING_FILE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># save the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    joblib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OUTPUT_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"../models/dt_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.bin"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In our script, we call the <strong>run</strong> function for each fold. When training bigger models this can be an issue as running multiple folds in the same script will keep increasing the memory consumption. This could potentially lead to the program crashing. We can get around this by using <strong>argparse</strong>. Argparse allows us to specify arguments in the command line which get parsed through to the script. Let's see how to implement this.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> argparse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># initialize Argument Parser</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parser </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> argparse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ArgumentParser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we can add any different arguments we want to parse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"--fold"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">type</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we then read the arguments from the comand line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parse_args</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># run the fold that we specified in the command line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So what have we done here? We have allowed us to specify the fold in the terminal.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; python train.py --fold 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Fold=3, Accuracy=0.861</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can use argparse in an even more useful way though, we can change the model with this! We can create a new python script, <code>model_dispatcher.py</code>, that has a dictionary containing different models. In this dictionary, the keys are the names of the models and the values are the models themselves.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/model_dispatcher.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> tree</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ensemble</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> linear_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> svm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">models </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token string" style="color:#e3116c">"decision_tree_gini"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tree</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DecisionTreeClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         criterion</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"gini"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token string" style="color:#e3116c">"decision_tree_entropy"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tree</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DecisionTreeClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         criterion</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">'entropy'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token string" style="color:#e3116c">"rf"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ensemble</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RandomForestClassifier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token string" style="color:#e3116c">"log_reg"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> linear_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LogisticRegression</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token string" style="color:#e3116c">"svc"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> svm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SVC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">C</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gamma</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kernel</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"rbf"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then add the following things to our code.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/train.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> argparse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> joblib</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sklearn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> model_dispatcher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we first read in data with our folds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TRAINING_FILE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># we then split it into our training and validation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    df_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">kfold </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> fold</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">drop</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># drop target column (label) and turn to np array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">drop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'label'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_train </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_train</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">drop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'label'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    y_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> df_valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">label</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fetch model from model dispatcher</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_dispatcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fit model on training data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_train</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y_train</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># create predictions for validation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    preds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> clf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># calculate and print accuracy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    score </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accuracy_score</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> preds</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f"Model=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">model</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Fold=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Accuracy=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">score</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># save the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    joblib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OUTPUT_PATH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f"../models/dt_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">fold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.bin"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"__main__"</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># initialize ArgumentParser class of argparse</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  parser </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> argparse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ArgumentParser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># add different arguments and their types</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  parser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'--fold'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">type</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  parser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'--model'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">type</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># read arguments from command line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  args </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parse_args</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># run with the fold and model specified by command line arguments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fold</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fold</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And that's it, now we can choose the fold and model in the terminal! What's great about this is that to try a new model/tweak hyperparameters, all we need to do is change our model dispatcher.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; python train.py --fold 2 --model rf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Model=rf, Fold=2, Accuracy=0.9658333333333333</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We also aren’t limited to just doing this. We can make dispatchers for loads of other things too: categorical encoders, feature selection, hyperparameter optimization, the list goes on!</p><p>To go even further, we can create a shell script to try a few different models from our dispatcher at once.</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/run.sh</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python train.py --fold 0 --model rf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python train.py --fold 0 --model decision_tree_gini</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python train.py --fold 0 --model log_reg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">python train.py --fold 0 --model svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Which, when run, gives:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; sh run.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Model=rf, Fold=0, Accuracy=0.9661666666666666</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Model=decision_tree_gini, Fold=0, Accuracy=0.8658333333333333</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Model=log_reg, Fold=0, Accuracy=0.917</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Model=svc, Fold=0, Accuracy=0.9671812654676666</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I first learned how to do all of this in Abhishek Thakur’s (quadruple Kaggle Grand Master) book: Approaching (Almost) Any Machine Learning Problem. It’s a fantastic and pragmatic exploration of data science problems. I would highly recommend it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-word-on-github">A word on Github<a class="hash-link" href="#a-word-on-github" title="Direct link to heading">​</a></h2><p>Once you’ve finished up (or during!) a problem that you find interesting make sure to create a Github repository and upload your datasets, python scripts, models, Jupyter notebooks, R scripts, etc. Creating Github repositories to showcase your work is extremely important! It also means you have some version control and you can access your code at all times.</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[The ins and outs of Gradient Descent]]></title>
        <id>Gradient-Descent</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Gradient-Descent"/>
        <updated>2020-10-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Optimizing your choice of optimizer]]></summary>
        <content type="html"><![CDATA[<p><strong>Optimizing your choice of optimizer</strong></p><p><strong>Gradient descent</strong> is an optimization algorithm used to minimize some cost function by iteratively moving in the direction of <strong>steepest descent</strong>. That is, moving in the direction which has the most negative gradient. In machine learning, we use gradient descent to continually tweak the parameters in our model in order to minimize a cost function. We start with some set of values for our model parameters (weights and biases in a neural network) and improve them slowly. In this blog post, we will start by exploring some basic optimizers commonly used in classical machine learning and then move on to some of the more popular algorithms used in Neural Networks and Deep Learning.</p><p>Imagine you're out for a run (or walk, whatever floats your boat) in the mountains and suddenly a thick mist comes in impairing your vision. A good strategy to get down the mountain is to feel the ground in every direction and take a step in the direction in which the ground is descending the fastest. Repeating this you should end up at the bottom of the mountain (although you might also end up at something that looks like the bottom that isn't — more on this later). This is exactly what gradient descent does: it measures the local gradient of the cost function <strong>J(ω)</strong> (parametrized by model parameters ω), and moves in the direction of descending gradient. Once we reach a gradient of zero, we have reached our minimum.</p><p>Suppose now that the steepness of the hill isn't immediately obvious to you (maybe you're too cold to feel your feet, use your imagination!), so you have to use your phone's accelerometer to measure the gradient. It's also really cold out so to check your phone you have to stop running and take your gloves off. Therefore, you need to minimize the use of your phone if you hope to make it down anytime soon! So you need to choose the right frequency at which you should measure the steepness of the hill so as not to go off track and at the same time reach home before the sunset. This amount of time between checks is what is known as the <strong>learning rate</strong> i.e. the size of steps we take downhill. If our learning rate is too small, then the algorithm will take a long time to converge. But, if our learning rate is too high the algorithm can diverge and just past the minimum.</p><p><img loading="lazy" alt="img1" src="/PersonalWebsite/assets/images/image1-bd8112b90c6c03a9430fff11530c9ccd.png" width="1400" height="1321" class="img_ev3q"></p><p>An important point to note is that not all cost functions are convex (the MSE cost function for Linear Regression is convex, however). A function is convex if the line segment between any two points on the graph of the function lies above the graph between the two points. Convexity is nice as it implies that there is a single global minimum. Problems start to occur when the cost functions aren’t convex: there may be ridges, plateaus, holes, etc. This makes convergence to the minimum difficult. Fortunately, there are techniques available to us to help combat some of these issues.</p><p><img loading="lazy" alt="img2" src="/PersonalWebsite/assets/images/image2-b2afbbf17cd27f3ca4bcd376f4eaa6f0.png" width="1400" height="1364" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="batch-gradient-descent">Batch Gradient Descent<a class="hash-link" href="#batch-gradient-descent" title="Direct link to heading">​</a></h2><p>The vanilla of the gradient descent world. In batch gradient descent we use the full training set X at each gradient step. Because of this, when using large training sets it can be agonizingly slow.
We start by finding the gradient vector of the cost function, we denote this by</p><p><img loading="lazy" alt="img3" src="data:image/png;base64,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" width="176" height="62" class="img_ev3q"></p><p>Here, <strong>J(ω)</strong> is the cost function parametrized by the model parameters <strong>ω</strong>) and <strong>∇</strong> denotes the vector differential operator. Now we have the gradient vector, we just need it to go in the opposite direction (downhill). Then, multiplying by the learning rate <strong>η</strong> we get our one-step gradient descent update equation:</p><p><img loading="lazy" alt="img3" src="data:image/png;base64,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" width="358" height="56" class="img_ev3q"></p><p>Implementation of batch gradient descent in python couldn't be simpler!</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/batch_gradient_descent.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># our chosen learning rate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iterations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token operator" style="color:#393A34">^</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">theta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># random initialization, with d being</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the dimension of theta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iterations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gradients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">n </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">X</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">theta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    theta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> theta </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> eta </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> gradients</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can use a grid search to find a good learning rate if we so desire. To find the correct number of iterations it normally suffices to set the number of iterations to a very large number but then interrupt the algorithm when the gradient vector (gradients) becomes smaller than some pre-set tolerance (normally denoted <strong>ϵ</strong>). This works because when the gradient vector becomes tiny, we are extremely close to our minimum.</p><p>One other important note is that when using Gradient Descent you should ensure that all of your features have a similar scale as otherwise, it will take much longer for the algorithm to converge — Sckikit-Learn’s StandardScaler usually does the trick. What can we do to speed up our optimizer though? Enter Stochastic Gradient Descent.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stochastic-gradient-descent">Stochastic Gradient Descent<a class="hash-link" href="#stochastic-gradient-descent" title="Direct link to heading">​</a></h2><p>Stochastic GD takes the opposite extreme to batch GD, rather than using the whole training set at each step, it takes a random instance of the training set at each step and uses this to work out the gradient. This is obviously going to be much faster than batch GD, especially when using huge training sets. The downside, however, is that due to its random behavior the algorithm is less regular: it only decreases on average as opposed to decreasing gradually at each step. Our final parameter values are therefore going to be good but not optimal (unlike batch gradient descent) as once we end up close to the minimum, the algorithm with continue to bounce around.</p><p>As unideal as this sounds, it can actually help! If for example, the cost function is very irregular (and not convex) the stochastic-ness can help in jumping out of local minima. So actually, stochastic GD actually has a better chance at finding the global minimum than plain old batch GD.</p><p>We can actually also do something to help deal with the lack of convergence when we get near the minimum: gradually reduce the learning rate. We can start with the steps being (relatively) large, this helps converge quicker to the minimum and also helps jump out of local minima. Gradually we can then reduce the learning rate, which allows the algorithm to settle down at the global minimum. This process is called a <strong>learning schedule</strong>. Learning rate scheduling is a pretty sweet technique, maybe I’ll give it its own blog post in the future.</p><p>The following code implements Stochastic Gradient Descent along with a (simple) learning schedule:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/stochastic_gradient_descent.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">epochs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Learning schedule hyperparams</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">learning_schedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> t0</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">theta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># random initialization, with d being</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the dimension of theta</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> epoch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">epochs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rand_idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> X</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rand_idx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">rand_idx</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        yi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rand_idx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">rand_idx</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gradients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> xi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">theta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> yi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> learning_schedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">epoch </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        theta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> theta </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> eta </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> gradients</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we iterate over rounds of n iterations, and each round is called an epoch.</p><p>It is also worth mentioning another method, <strong>Mini-batch Gradient Descent</strong>. To put it simply, it is just a combination of both Batch and Stochastic GD methods: at each step, Mini-batch GD computes the gradients on a small random subset of the training instances (a mini-batch). This has the advantage of being less erratic than Stochastic GD; however, it is more likely to get stuck in local minimums.</p><p>So far we have discussed the more classical GD algorithms which perform to a satisfactory level when training more classic ML models, for example, SVMs, Random Forests, etc. But, using these methods to train large deep natural networks can be mind-numbingly slow. Faster optimizers can provide us with an extra speed boost in training. A few of the most popular algorithms will be discussed below.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="momentum-optimisation">Momentum Optimisation<a class="hash-link" href="#momentum-optimisation" title="Direct link to heading">​</a></h2><p>Instead of using only the gradient of the loss function at the current step to guide the search, momentum optimization uses the concept of momentum and accumulates the previous gradients to help determine the direction to go. Thinking back to our analogy earlier: imagine you are now on a bike and you were riding down the mountain, you will start slow but you will gradually start to pick up more and more momentum until you reach a terminal velocity. This is exactly what the momentum algorithm does. Another way to think of it is that the gradient vector is now used for acceleration as opposed to speed. An update equation for our model parameters is hence given by:</p><p><img loading="lazy" alt="img3" src="data:image/png;base64,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" width="380" height="100" class="img_ev3q"></p><p>At each iteration, we subtract the local gradient (multiplied by <strong>η</strong>) from the momentum vector m and then update the weights <strong>ω</strong> by adding the momentum vector. As well as converging faster in general, the momentum helps the algorithm escape from plateaus faster and also roll past local minima. The hyperparameter <strong>β</strong> is the amount of friction in the system, the higher the β the slower the terminal velocity.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nesterov-accelerated-gradient">Nesterov Accelerated Gradient<a class="hash-link" href="#nesterov-accelerated-gradient" title="Direct link to heading">​</a></h2><p>With one slight adjustment to the momentum algorithm, we can almost always get faster convergence. The NAG method measures the gradient of the cost function slightly ahead of the local position <strong>ω</strong>. The one-step update is given by</p><p><img loading="lazy" alt="img3" src="data:image/png;base64,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" width="518" height="100" class="img_ev3q"></p><p>The reason this works is simple: in general, the momentum vector is pointing towards the minimum, so measuring the gradient a little bit further in that direction will help. These small speed improvements then add up and ultimately the NAG algorithm ends up being significantly faster. Implementing this in Keras is incredibly easy, we can just put:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> keras</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optimizers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SGD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> momentum</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nesterov</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rmsprop">RMSProp<a class="hash-link" href="#rmsprop" title="Direct link to heading">​</a></h2><p>The RMSProp algorithm is an altered version of the <strong>AdaGrad</strong> algorithm, introduced by Geoffrey Hinton and Tijmen Tieleman in 2012 (so pretty recently in mathematics terms!). Imagine a scenario where the cost function looks like an elongated bowl, the GD algorithm will start going down the steepest slope but this slope doesn't point directly towards the global minimum. The AdaGrad algorithm provides us with a correction so that the algorithm does indeed actually move towards the global minimum. It does this by scaling down the gradient vector along the steepest dimensions. Another way to think of this is that we decaying the learning rate faster in steeper dimensions and slower in dimensions with a more gentle slope. The easiest way to understand how this works is to get hands-on with the one-step update equations:</p><p><img loading="lazy" alt="img3" src="/PersonalWebsite/assets/images/math5-827b0a72cba756630452998f5c3bbaff.png" width="452" height="98" class="img_ev3q"></p><p>Here the <strong>𝇇</strong> represents element-wise multiplication. Therefore each element of s is given by</p><p><img loading="lazy" alt="img3" src="data:image/png;base64,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" width="326" height="84" class="img_ev3q"></p><p>So if the cost function <strong>J(ω)</strong> is steep in the i-th dimension, then s is going to accumulate and get larger and larger as we iterate through. The second step here is practically the same as the usual gradient descent update except we scale down the gradient vector in relation to <strong>s</strong>. The <strong>⊘</strong> represent element-wise division, thus the bigger each element of the gradient vector, the smaller the step we take in that direction. The ε term is a very small smoothing term (e.g. <strong>ε = 1e-10</strong>) and it is just there to avoid division by zero (I once divided by zero and had a nose bleed, its the devils work).</p><p>The problem with AdaGrad however, is that it often stops too early when training neural networks. This is because the learning rate gets scaled down too much. RMSProp makes one simple adjustment. Instead, we exponentially decay the gradients accumulated in the most recent iterations.</p><p><img loading="lazy" alt="img3" src="/PersonalWebsite/assets/images/math7-c9f76e5e39b65f6b8c16ce2b6bb9568d.png" width="566" height="90" class="img_ev3q"></p><p>Although we have introduced a new hyperparameter to tune (<strong>ρ</strong>), the value <strong>ρ = 0.9</strong> normally does the trick. As you can probably guess by now, implementing RMSProp in Keras is very easy:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> keras</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optimizers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RMSprop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rho</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>I guess now it's time to talk about the big daddy of optimizers.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="adam-and-nadam-optimization">Adam and Nadam Optimization<a class="hash-link" href="#adam-and-nadam-optimization" title="Direct link to heading">​</a></h2><p>Adaptive moment estimation (Adam) combines two of the methods we have already looked at: momentum and RMSProp optimization. It steals the idea of keeping track of an exponentially decaying average of previous gradients from momentum optimization and the idea of keeping track of exponentially decaying averages of past squared gradients from RMSProp.</p><p><img loading="lazy" alt="img3" src="/PersonalWebsite/assets/images/math8-2c1a138c227a2f70fb095144f8ee6c88.png" width="466" height="184" class="img_ev3q"></p><p>Here, <strong>t</strong> is the iteration number (starting at 1). The first, second, and fifth equations are almost identical to the momentum and RMSProp optimization algorithms, with the difference coming from hyperparameters. The third and fourth equations are simply there to boost <strong>m</strong> and <strong>s</strong> at the start of the algorithm as initially, they are biased towards 0. As with all things in Keras, Adam is extremely easy to implement (the hyperparameters default values are given below, also).</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> keras</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optimizers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Adam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beta_1</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beta_2</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.999</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <strong>Nadam</strong> algorithm is the same as the Adam algorithm but it also includes the Nesterov trick, meaning it often converges slightly faster than standard Adam.</p><p>Another, not immediately obvious, advantage of Adam (and with Nadam and RMSProp) is that it requires less tuning of <strong>η</strong> — so, in some ways, it's even easier to implement than the standard vanilla GD method!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>We went from classic vanilla gradient descent and gradually got more and more complex with our methodology. When working with the less computing power-intensive models I have found usually the simple SGD/mini-batch models work really well. When training large neural networks the likes of Adam/Nadam and RMSProp tend to work great. As with everything in the ML world, having a little play around experimenting with different methods often leads to the best results.</p><p>One closing remark: it has been <a href="https://arxiv.org/abs/1705.08292" target="_blank" rel="noopener noreferrer">found</a> that sometimes adaptive optimization methodologies (Adam, Nadam, RMSProp) can sometimes lead to solutions that generalize poorly so if you find this problem, maybe give the NAG method a try!</p><p>If you found this article interesting, I would highly recommend picking up a copy of Hands-On Machine Learning with Scikit-Learn and TensorFlow by Aurélien Géron. It's an absolutely incredible book and it’s where I first read about a lot of the content in this post!</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Optimization" term="Optimization"/>
        <category label="Mathematics" term="Mathematics"/>
        <category label="Python" term="Python"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Using BeautifulSoup to Help Make Beautiful Soups]]></title>
        <id>Recipe-Recommendation1</id>
        <link href="https://jackmleitch.github.io/PersonalWebsite/blog/Recipe-Recommendation1"/>
        <updated>2020-10-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[The journey to my first ‘full-stack’ data science project — a practical guide to web scraping]]></summary>
        <content type="html"><![CDATA[<p><strong>The journey to my first ‘full-stack’ data science project — a practical guide to web scraping</strong></p><p>I’ve had my fun playing around with all the ‘classic’ ML datasets (the likes of MNIST, Titanic, Iris, etc.) and I decided it's time to start something of my own. The main reason being that I simply want something different. It all felt somewhat artificial, I want something new and challenging. Something that is not served to me on a silver platter.</p><p>I spend a good while mulling over possible projects and came up with a few possible avenues, one of which I will go over in this post. To help get more out of the experience, I thought I would blog my journey.</p><p>As a student, I often fall into the trap of cooking the same recipes over and over again. On one hand, it’s pretty great, I know what I am eating and I know that what I am putting in my meals works for me. But oh boy is it boring (as I'm writing this I'm tucking into my 3rd portion of bolognese in four days…).</p><p>So… the idea: Given a list of ingredients, what are different recipes I can make? That is, what recipes can I make with the food I have in my apartment?</p><p>I hope to build a recommendation system in which the ingredients available by the user is taken as input, and the appropriate dishes or recipes are recommended to the user by Machine Learning (most likely) using the K-Nearest Neighbors algorithm. I hope to then use Flask to deploy the model so that the output can be visualized in a convenient and user-friendly way.</p><p>This project idea appeals to me in a few ways:</p><ul><li><p>I can find and <a href="https://en.wikipedia.org/wiki/Web_scraping" target="_blank" rel="noopener noreferrer">scrape</a> the data myself</p></li><li><p>Hopefully, by the end of it, I will have a product that I’ll actually use</p></li><li><p>It’s open-ended, e.g. can I take a picture of the ingredients in my fridge as opposed to inputting ingredients manually?</p></li></ul><p>I have had a lot of practice in the machine learning aspect of data science but that isn't all there is. I want to practice using a diverse set of tools to solve a wide range of problems, and web scraping is definitely something I need to brush up on. So, this blog is dedicated to just that.</p><p>First things first, I need a data source. I frequently use Jamie Oliver’s <a href="https://www.jamieoliver.com/" target="_blank" rel="noopener noreferrer">cooking website</a> and I really enjoy a lot of the recipes on there so this was a fairly obvious source of data for me. The other benefits are that is popular to the general public and it well maintained/monitored.</p><p>The complete code for scraping the recipe data from Jamie Oliver’s website can be found on my <a href="https://github.com/jackmleitch/Whatscooking-" target="_blank" rel="noopener noreferrer">GitHub</a>. Side note: I prefer to not use Jupyter Notebooks for anything other than <a href="https://en.wikipedia.org/wiki/Exploratory_data_analysis" target="_blank" rel="noopener noreferrer">EDA</a>. Maybe I will do another blog post about this in the future but in the meantime, some food for thought on the topic can be found <a href="https://towardsdatascience.com/the-case-against-the-jupyter-notebook-d4da17e97243" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lets-get-some-data">Let's get some data!<a class="hash-link" href="#lets-get-some-data" title="Direct link to heading">​</a></h2><p>So what libraries do we need? The most common for web scraping include <code>requests</code>, Beautiful Soup (<code>bs4</code>), and <code>Selenium</code>. In this case, we will be using requests and Beautiful Soup. Although Selenium is very adequate, it’s just not needed in this here. We are pulling content from static HTML pages and you would use Selenium when crawling content that is added to the page via JavaScript. Using Selenium here is just going to slow us down.</p><p>Before we get going we should do a little bit of exploring.</p><p><img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/jmo1-f439d62a20c590445f4602d04ce41bd4.png" width="2342" height="1432" class="img_ev3q">
<img loading="lazy" alt="alt" src="/PersonalWebsite/assets/images/jmo2-f74efdbb34616094e83ce49ae40881e0.png" width="2546" height="1426" class="img_ev3q"></p><p>The ‘<a href="https://www.jamieoliver.com/recipes/category/course/mains/" target="_blank" rel="noopener noreferrer">main recipes</a>’ section of the website contains 858 different recipes, perfect -we now know where to look. We can break this task up into two steps.</p><ul><li><p>Step 1: obtain URLs to each recipe page</p></li><li><p>Step 2: Within each of these URLs, find recipe attributes: recipe name, ingredients, serving size, cooking time, and difficulty.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="set-up">Set up<a class="hash-link" href="#set-up" title="Direct link to heading">​</a></h2><p>We want to import requests, BeautifulSoup, pandas and time (I will get to time later.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> bs4 </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BeautifulSoup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> time</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We then want to specify the URL we want to scrape. It is worth noting that all the recipe links are on the same webpage, so we solely want to scrape URL links from <a href="https://www.jamieoliver.com/recipes/category/course/mains/" target="_blank" rel="noopener noreferrer">https://www.jamieoliver.com/recipes/category/course/mains/</a>. That is, we don't need to add <code>/page1</code>, <code>/page2</code> etc.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Define the url in python</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> “https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">//</span><span class="token plain">www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jamieoliver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">recipes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">category</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">course</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mains</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-1">Step 1<a class="hash-link" href="#step-1" title="Direct link to heading">​</a></h2><p>Now we use requests to retrieve content from the URL and BeautifulSoup to extract the required information from our requested content. Our target website is written in HTML so we need to use the <code>html.parser</code>.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Fetching html from the website</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># BeautifulSoup enables to find the elements/tags in a webpage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">soup </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BeautifulSoup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">page</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> “html</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parser”</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, what are we working with? Let's print the soup variable…</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">soup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”recipe</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">block”</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">a href</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">recipes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fish</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">recipes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">chargrilled</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">tuna</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">with</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">oregano</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">oil</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">and</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">beautifully</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">dressed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">peas</span><span class="token operator" style="color:#393A34">-</span><span class="token keyword" style="color:#00009f">and</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">broad</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">beans</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">” </span><span class="token builtin">id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”gtm_recipe_subcat_816"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">div </span><span class="token keyword" style="color:#00009f">class</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”recipe</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">image”</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">img alt</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”Chargrilled tuna </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> oregano oil </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> beautifully dressed peas </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> broad beans” data</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">src</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">”</span><span class="token operator" style="color:#393A34">//</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jamieoliver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">jamieoliver</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">recipe</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">database</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">oldImages</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">large</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">117_1_1436538108</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jpg?tr</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">w</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">330</span><span class="token plain">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Well, that's certainly intimidating. Our data is in there somewhere though (as shown in bold), we just need to extract it. We want to find all of the href’s in our ‘soup’ so fairly intuitively we can just use BeautifulSoups <code>find_all</code> method. How convenient. The only information we want to extract from here are the <code>a</code> elements (the <code>a</code> tag is used to define hyperlinks, a complete list of HTML tags can be found <a href="https://eastmanreference.com/complete-list-of-html-tags" target="_blank" rel="noopener noreferrer">here</a>). We then want to make use of the get method to extract the href from inside each <code>a</code> tag. We can print the first 5 URLs by running the following code:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">links </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> link </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> soup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'a'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    links</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'href'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">links</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">105</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'/recipes/pasta-recipes/beautiful-courgette-penne-carbonara/'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/recipes/vegetable-recipes/roasted-black-bean-burgers/'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/recipes/chicken-recipes/chicken-tofu-noodle-soup/'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/recipes/chicken-recipes/chicken-katsu-curry/'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">'/recipes/salmon-recipes/roasted-salmon-artichokes/'</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Perfect, that worked great. Well… kinda, there is a reason I chose to print from 100 to 105. There are a lot of elements in this list that aren’t URLs for recipes, for example <code>/videos/</code> or <code>/recipes/category/course/healthy-snack-ideas/</code>. However, we can make use of the Pandas <code>series.str.contains</code> to see if a pattern or regex is contained within a string of the Series.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Filtering the urls to only ones containing recipes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recipe_urls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Series</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"href"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> a </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> soup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recipe_urls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recipe_urls</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">recipes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">==</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">recipes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">==</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“course”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">==</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“books”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">==</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_urls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endswith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“recipes</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">==</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unique</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This piece of code makes convenient use of list comprehensions, then we filter the URLs a little bit e.g. all of the recipes contain at least 1 ‘-’ so we only take hrefs with <code>count(“-”)&gt;0</code>.</p><p>The hrefs we have obtained are only the trail end of each URL so we finally just need to add in the start of the full URL to all these items.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> “https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">//</span><span class="token plain">www</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jamieoliver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com" </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">‘</span><span class="token builtin">str</span><span class="token plain">’</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="step-2">Step 2<a class="hash-link" href="#step-2" title="Direct link to heading">​</a></h2><p>We now have 858 URLs to the different recipe pages, so let's just pick one and figure what data we want to collect from each page. From there we then generalize and automate the process. I’m a big pasta guy so let's look at some <a href="https://www.jamieoliver.com/recipes/pasta-recipes/beautiful-courgette-penne-carbonara/" target="_blank" rel="noopener noreferrer">Beautiful courgette carbonara</a>. I want to extract the recipe title, ingredients, number of people it serves, cooking time, and difficulty. I’m conscious of repeating myself so I will just walk through getting the recipe title and ingredients (the most faffy one). As per usual, the inspecting element tool is our friend. If we inspect the title on the page we find the HTML:</p><p><code>&lt;h1 class=”hidden-xs”&gt;Beautiful courgette carbonara&lt;/h1&gt;</code></p><p><code>&lt;h1&gt;</code> tags are used to define HTML headings. Therefore, to get the main webpage title we can just do the following:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'https://www.jamieoliver.com/recipes/pasta-recipes/beautiful-courgette-penne-carbonara/'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">soup </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BeautifulSoup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'html.parser'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">soup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">‘h1’</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Beautiful courgette carbonara</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The find method allows us to just obtain the first <code>&lt;h1&gt;</code> tag rather than all of them (<code>find_all</code>). I then used <code>.strip()</code> to remove all the leading and trailing spaces from the string.</p><p>Right, so what do we need to make our pasta? By inspecting we find the ingredients are in list tags <code>&lt;li&gt;</code>:</p><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ul</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">”ingred-list</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">“</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">6 medium green and yellow courgettes</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">500 g penne</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">4 large free-range eggs</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">100 ml single cream</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">li</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ul</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can loop over all the elements in the list and append them to an ingredients list. There is a lot of empty space in each list element so we can split up each ingredient into single words (using <code>.split()</code>) and then join the string back up again (using <code>' '.join()</code>). A simple but elegant solution.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> li </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> soup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">‘</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingred</span><span class="token operator" style="color:#393A34">-</span><span class="token builtin">list</span><span class="token plain"> li’</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingred </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ‘ ‘</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">li</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ingredients</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingred</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingredients</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ['6 medium green and yellow courgettes', '500 g penne', '4 large free-range eggs', '100 ml single cream', '1 small handful of Parmesan cheese', 'olive oil', '6 slices of higher-welfare back bacon', '½ a bunch of fresh thyme , (15g)', 'a few courgette flowers , (optional)']</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Excellent. I then created a class that I could call on to extract all the information from each URL. I mentioned earlier that there might be URLs that are not recipes so we can use a <code>try</code> <code>except</code> condition in case the information is not found (e.g. the <a href="https://www.jamieoliver.com/videos/" target="_blank" rel="noopener noreferrer">videos</a> page does not contain an ingredient list). I just added in Na values here, which will make it very easy to remove these URLs later. Again, the full scripts can be found on my <a href="https://github.com/jackmleitch/Whatscooking-" target="_blank" rel="noopener noreferrer">Github</a>.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/web_scrape_jamie_oliver.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">JamieOliver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">soup </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BeautifulSoup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'html.parser'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ingredients</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">“”” Creating a </span><span class="token builtin">list</span><span class="token plain"> containing the ingredients of the recipe “””</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ingredients </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> li </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">soup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">‘</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ingred</span><span class="token operator" style="color:#393A34">-</span><span class="token builtin">list</span><span class="token plain"> li’</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ingred </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ‘ ‘</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">li</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ingredients</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingred</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ingredients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">except</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="all-together-now">All together now<a class="hash-link" href="#all-together-now" title="Direct link to heading">​</a></h2><p>All that's left for us to do now is to loop over each URL in our data frame (<code>recipe_df</code>). A word of caution though: we don't want to overload the website by making a tonne of requests in a short period of time (we also don't want to get blocked…), this is where the <code>time.sleep</code> method comes in. It simply suspends a program for a given number of seconds. Using NumPy's <code>random.randint()</code> method we can pause our program by a random number of seconds, <code>random.randint(5,10,1)</code> pauses it anytime between 5 and 10 seconds for example.</p><p>If you want you can also identify yourself to the website by using a header in the following way.</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">'user-agent'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5); Jack Leitch'</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> requests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The following code finishes off the scrape and writes the data frame created to a CSV file:</p><div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">/src/scrape_data.py</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">attribs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_name’</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ‘serves’</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ‘cooking_time’</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ‘difficulty’</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ‘ingredients’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># For each url (i) we add the attribute data to the i-th row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JamieOliver_df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columns</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">attribs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    recipe_scraper </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JamieOliver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recipe_scraper</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrib</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> attrib </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> attribs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f’Step </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> completed’</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Put all the data into the same dataframe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JamieOliver_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recipe_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Re-organise columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">columns </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">‘recipe_urls’</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> attribs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JamieOliver_df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JamieOliver_df</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">columns</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Save dataframe to a csv file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JamieOliver_df</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_csv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r"/Users/Jack/Documents/ML/Projects/Whatscooking/input/JamieOliver_full.csv"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>We started by connecting to the webpage, we then parsed the HTML using BeautifulSoup, then for each recipe webpage we looped through the soup object to extract the relevant information.</p><p>This is my first ever blog post so any feedback would be much appreciated and please give this a clap or comment if you enjoyed it/found it useful.</p><p>I hope to continue with these blogs as I progress further with my first end to end data science project. In the next post, I will be preprocessing my data (using nltk) and doing some data visualization. Thanks for reading!</p>]]></content>
        <author>
            <name>Jack Leitch</name>
            <uri>https://github.com/jackmleitch</uri>
        </author>
        <category label="Python" term="Python"/>
        <category label="Web Scraping" term="Web Scraping"/>
    </entry>
</feed>